<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAP ‚Äî Logistics Execution and Acceleration Platform</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Figtree:wght@300;400;500;600&display=swap');

:root {
  --bg:#f0f2f5; --surface:#fff; --surface2:#f7f8fa;
  --border:#e2e6ed; --border2:#cdd3dc;
  --ink:#111827; --ink2:#374151; --ink3:#6b7280; --ink4:#9ca3af;
  --navy:#0f1f3d; --blue:#1d4ed8; --blue-lt:#dbeafe;
  --teal:#0d9488; --teal-lt:#ccfbf1;
  --amber:#d97706; --amber-lt:#fef3c7;
  --red:#dc2626; --red-lt:#fee2e2;
  --green:#16a34a; --green-lt:#dcfce7;
  --purple:#7c3aed; --purple-lt:#ede9fe;
  --orange:#ea580c; --orange-lt:#ffedd5;
  --sidebar-w:220px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Figtree',sans-serif;background:var(--bg);color:var(--ink);font-size:13px;}
.app{display:flex;height:100vh;overflow:hidden;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--navy);display:flex;flex-direction:column;}
.sb-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:8px;}
.sb-logo-mark{font-family:'Syne',sans-serif;font-size:17px;font-weight:800;color:#fff;}
.sb-logo-mark span{color:#38bdf8;}
.sb-logo-sub{font-size:9px;color:rgba(255,255,255,0.3);letter-spacing:.5px;margin-top:3px;line-height:1.4;}
.sb-section{padding:0 8px;margin-bottom:6px;}
.sb-module-header{display:flex;align-items:center;gap:7px;padding:10px 10px 5px;}
.sb-module-icon{font-size:12px;}
.sb-module-label{font-size:9px;font-weight:700;letter-spacing:.5px;color:rgba(255,255,255,0.35);white-space:nowrap;}
.sb-module-divider{flex:1;height:1px;background:rgba(255,255,255,0.08);margin-left:4px;}
.sb-item{display:flex;align-items:center;gap:8px;padding:7px 10px 7px 24px;border-radius:7px;color:rgba(255,255,255,0.5);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;margin-bottom:1px;}
.sb-item:hover{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.85);}
.sb-item.active{background:rgba(56,189,248,0.15);color:#38bdf8;}
.sb-icon{font-size:13px;width:16px;text-align:center;}
.sb-bottom{margin-top:auto;padding:10px 8px;border-top:1px solid rgba(255,255,255,0.07);}
.sb-settings{display:flex;align-items:center;gap:8px;padding:7px 10px;border-radius:7px;color:rgba(255,255,255,0.35);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;}
.sb-settings:hover{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.65);}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 22px;height:52px;display:flex;align-items:center;gap:8px;flex-shrink:0;position:sticky;top:0;z-index:10;}
.topbar-module{font-size:11px;color:var(--ink4);font-weight:500;}
.topbar-sep{color:var(--border2);font-size:13px;}
.topbar-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:8px;}
.api-status{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;}
.api-status.ok{background:var(--green-lt);color:var(--green);}
.api-status.err{background:var(--red-lt);color:var(--red);}
.api-status.checking{background:var(--amber-lt);color:var(--amber);}

/* ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ */
.page{padding:22px;flex:1;display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}

/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Figtree',sans-serif;}
.btn-primary{background:var(--blue);color:#fff;}
.btn-primary:hover{background:#1e40af;}
.btn-primary:disabled{background:var(--border2);color:var(--ink4);cursor:not-allowed;}
.btn-btf{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(124,58,237,0.3);white-space:nowrap;}
.btn-btf:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);transform:translateY(-1px);}
.btn-po{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#ea580c,#c2410c);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(234,88,12,0.3);white-space:nowrap;}
.btn-po:hover{background:linear-gradient(135deg,#c2410c,#9a3412);transform:translateY(-1px);}
.btn-usb{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#0d9488,#0f766e);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(13,148,136,0.3);white-space:nowrap;}
.btn-usb:hover{background:linear-gradient(135deg,#0f766e,#115e59);transform:translateY(-1px);}
.btn-sent-ok{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--green-lt);color:var(--green);border:1px solid #86efac;white-space:nowrap;}
.btn-sending{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--surface2);color:var(--ink3);border:1px solid var(--border);white-space:nowrap;}

/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.card-header{padding:11px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.card-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;}
.card-body{padding:14px 16px;}

/* ‚îÄ‚îÄ CHIPS ‚îÄ‚îÄ */
.chip{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;}
.chip-teal{background:var(--teal-lt);color:var(--teal);}
.chip-gray{background:var(--surface2);color:var(--ink3);border:1px solid var(--border);}
.chip-blue{background:var(--blue-lt);color:var(--blue);}
.chip-amber{background:var(--amber-lt);color:var(--amber);}
.chip-red{background:var(--red-lt);color:var(--red);}
.chip-green{background:var(--green-lt);color:var(--green);}
.chip-purple{background:var(--purple-lt);color:var(--purple);}
.chip-orange{background:var(--orange-lt);color:var(--orange);}

/* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;table-layout:auto;}
thead th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.5px;color:var(--ink3);background:var(--surface2);border-bottom:1px solid var(--border);white-space:nowrap;}
thead th.status-col{background:#f0f7ff;color:var(--blue);border-bottom:2px solid #93c5fd;}
thead th.fp-col{background:#f0fdfb;color:var(--teal);border-bottom:2px solid #5eead4;}
thead th.action-col{background:#faf5ff;color:var(--purple);border-bottom:2px solid #c4b5fd;}
thead th.ums-col{background:#f0f7ff;color:var(--blue);border-bottom:2px solid #93c5fd;}
thead th.otm-col{background:#f0fdfb;color:var(--teal);border-bottom:2px solid #5eead4;}
thead th.diff-col{background:#faf5ff;color:var(--purple);border-bottom:2px solid #c4b5fd;}
tbody td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;color:var(--ink2);vertical-align:middle;white-space:nowrap;}
tbody tr:last-child td{border-bottom:none;}
tbody tr.row-fp{background:#fafffe;}
tbody tr.row-not-found{background:#fff8f8;}
tbody tr.row-not-found td:first-child{border-left:3px solid var(--red);}
tbody tr.row-mismatch{background:#fffdf0;}
tbody tr.row-mismatch td:first-child{border-left:3px solid var(--amber);}
tbody tr.row-matched{background:#f0fff4;}
tbody tr.row-matched td:first-child{border-left:3px solid var(--green);}

/* ‚îÄ‚îÄ STATUS CELLS ‚îÄ‚îÄ */
.st{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;}
.st-ok{color:var(--green);}
.st-warn{color:var(--amber);}
.st-err{color:var(--red);}
.st-null{color:var(--ink4);font-weight:400;}

/* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
.input{width:100%;padding:7px 11px;border-radius:7px;border:1px solid var(--border2);background:var(--surface);font-size:12px;font-family:'Figtree',sans-serif;color:var(--ink);outline:none;transition:border-color .15s,box-shadow .15s;}
.input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(29,78,216,0.1);}
.input-group{position:relative;}
.input-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none;}
.input-group .input{padding-left:30px;}
.mono{font-family:'JetBrains Mono',monospace;font-size:11px;}

/* ‚îÄ‚îÄ PAGE HEADERS ‚îÄ‚îÄ */
.page-head{margin-bottom:18px;}
.page-head h1{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.page-head p{color:var(--ink3);font-size:12px;}

/* ‚îÄ‚îÄ SEARCH BAR ‚îÄ‚îÄ */
.search-bar{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;}

/* ‚îÄ‚îÄ STATES ‚îÄ‚îÄ */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.spinner-dark{border-color:rgba(0,0,0,0.1);border-top-color:var(--blue);}
.state-box{text-align:center;padding:50px 20px;color:var(--ink4);}
.state-box .icon{font-size:36px;margin-bottom:10px;}
.state-box h3{font-size:13px;font-weight:600;color:var(--ink3);margin-bottom:4px;}
.state-box p{font-size:11px;}
.error-banner{background:var(--red-lt);border:1px solid #fca5a5;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--red);display:flex;align-items:flex-start;gap:8px;}

/* ‚îÄ‚îÄ RESULT META ‚îÄ‚îÄ */
.result-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.query-tag{font-size:10px;padding:2px 7px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;color:var(--ink3);}
.query-tag.has-results{background:var(--blue-lt);border-color:#93c5fd;color:var(--blue);}

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:#fff;border-radius:14px;width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.2);transform:translateY(10px) scale(0.98);transition:transform .2s;overflow:hidden;}
.overlay.open .modal{transform:translateY(0) scale(1);}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.modal-icon-btf{background:var(--purple-lt);}
.modal-icon-po{background:var(--orange-lt);}
.modal-icon-usb{background:var(--teal-lt);}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;margin-bottom:2px;}
.modal-sub{font-size:11px;color:var(--ink3);}
.modal-body{padding:18px 22px;}
.modal-detail{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:14px;}
.modal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.modal-row:last-child{margin-bottom:0;}
.modal-lbl{font-size:11px;color:var(--ink3);font-weight:500;}
.modal-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--ink);}
.modal-warning{border-radius:7px;padding:10px 12px;font-size:11px;display:flex;gap:8px;align-items:flex-start;}
.modal-warning-btf{background:var(--amber-lt);border:1px solid #fcd34d;color:#92400e;}
.modal-warning-po{background:var(--orange-lt);border:1px solid #fdba74;color:#9a3412;}
.modal-warning-usb{background:var(--teal-lt);border:1px solid #5eead4;color:#134e4a;}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{background:var(--surface2);color:var(--ink2);border:1px solid var(--border2);padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Figtree',sans-serif;}
.btn-cancel:hover{background:var(--border);}
.btn-confirm-btf{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-btf:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);}
.btn-confirm-po{background:linear-gradient(135deg,#ea580c,#c2410c);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-po:hover{background:linear-gradient(135deg,#c2410c,#9a3412);}
.btn-confirm-usb{background:linear-gradient(135deg,#0d9488,#0f766e);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-usb:hover{background:linear-gradient(135deg,#0f766e,#115e59);}

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 18px;border-radius:10px;font-size:12px;font-weight:600;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.15);transform:translateY(10px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-ok{background:var(--green-lt);color:var(--green);border:1px solid #86efac;}
.toast-err{background:var(--red-lt);color:var(--red);border:1px solid #fca5a5;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* ‚îÄ‚îÄ BULK RESULTS ‚îÄ‚îÄ */
.bulk-group{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:14px;}
.bulk-group-header{padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}
.bulk-group-header:hover{background:#eef0f5;}
.bulk-group-xid{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--blue);}
.bulk-group-count{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;}
.bulk-group-count.found{background:var(--green-lt);color:var(--green);}
.bulk-group-count.none{background:var(--surface2);color:var(--ink4);border:1px solid var(--border);}
.bulk-group-count.error{background:var(--red-lt);color:var(--red);}
.bulk-group-toggle{margin-left:auto;font-size:12px;color:var(--ink4);transition:transform .2s;}
.bulk-group.collapsed .bulk-group-toggle{transform:rotate(-90deg);}
.bulk-group.collapsed .bulk-group-body{display:none;}
.bulk-group-body{overflow-x:auto;}
.bulk-summary-bar{display:flex;align-items:center;gap:14px;padding:10px 16px;background:#f8f9fb;border-bottom:1px solid var(--border);font-size:11px;color:var(--ink3);}
.bulk-summary-bar strong{color:var(--ink);font-weight:700;}

/* ‚îÄ‚îÄ UMS RECONCILIATION ‚îÄ‚îÄ */
.upload-zone{background:var(--surface);border:2px dashed var(--border2);border-radius:12px;padding:24px 22px;margin-bottom:16px;display:flex;align-items:center;gap:20px;transition:border-color .2s,background .2s;cursor:pointer;}
.upload-zone:hover{border-color:var(--blue);background:#f8faff;}
.upload-zone.has-file{border-style:solid;border-color:#86efac;background:var(--green-lt);}
.upload-icon{width:44px;height:44px;border-radius:10px;background:var(--blue-lt);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0;}
.upload-zone.has-file .upload-icon{background:var(--green-lt);}
.upload-text h3{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;margin-bottom:2px;}
.upload-text p{font-size:11px;color:var(--ink3);}
.upload-zone.has-file .upload-text h3{color:var(--green);}
.upload-actions{margin-left:auto;flex-shrink:0;}
.config-row{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:14px;flex-wrap:wrap;}
.config-label{font-size:10px;font-weight:700;color:var(--ink3);letter-spacing:.5px;white-space:nowrap;}
.toggle-group{display:flex;background:var(--surface2);border:1px solid var(--border);border-radius:7px;overflow:hidden;}
.toggle-opt{padding:5px 12px;font-size:11px;font-weight:600;color:var(--ink3);cursor:pointer;transition:all .15s;border:none;background:none;font-family:'Figtree',sans-serif;}
.toggle-opt.active{background:var(--navy);color:#fff;}
.config-divider{width:1px;height:26px;background:var(--border);flex-shrink:0;}
.run-btn{margin-left:auto;display:inline-flex;align-items:center;gap:7px;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;background:linear-gradient(135deg,#1d4ed8,#1e40af);color:#fff;font-family:'Figtree',sans-serif;transition:all .15s;box-shadow:0 2px 8px rgba(29,78,216,0.25);}
.run-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(29,78,216,0.35);}
.run-btn:disabled{background:var(--border2);color:var(--ink4);cursor:not-allowed;box-shadow:none;transform:none;}
.progress-wrap{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:14px 18px;margin-bottom:16px;display:none;}
.progress-wrap.visible{display:block;}
.progress-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
.progress-label{font-size:12px;font-weight:600;}
.progress-count{font-family:'JetBrains Mono',monospace;font-size:11px;color:var(--ink3);}
.progress-bar-bg{height:5px;background:var(--surface2);border-radius:10px;overflow:hidden;}
.progress-bar-fill{height:100%;background:linear-gradient(90deg,#1d4ed8,#38bdf8);border-radius:10px;transition:width .4s ease;}
.progress-steps{display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;}
.progress-step{font-size:10px;padding:2px 8px;border-radius:20px;font-weight:600;}
.progress-step.done{background:var(--green-lt);color:var(--green);}
.progress-step.active{background:var(--blue-lt);color:var(--blue);}
.progress-step.pending{background:var(--surface2);color:var(--ink4);}
.summary-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px;}
.sum-card{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:13px 15px;display:flex;align-items:center;gap:11px;}
.sum-icon{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.sum-val{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;line-height:1;}
.sum-lbl{font-size:10px;color:var(--ink3);margin-top:2px;}
.sum-card.hl-red{border-color:#fca5a5;background:#fff8f8;}
.sum-card.hl-amber{border-color:#fcd34d;background:#fffdf0;}
.sum-card.hl-green{border-color:#86efac;background:#f0fff4;}
.sum-card.hl-orange{border-color:#fdba74;background:#fff8f2;}
.age-badge{display:inline-flex;align-items:center;padding:2px 7px;border-radius:5px;font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:700;}
.age-critical{background:var(--red-lt);color:var(--red);}
.age-warn{background:var(--amber-lt);color:var(--amber);}
.age-ok{background:var(--green-lt);color:var(--green);}
.expand-btn{background:none;border:none;cursor:pointer;color:var(--ink4);font-size:12px;padding:2px 5px;border-radius:4px;transition:all .15s;}
.expand-btn:hover{background:var(--surface2);color:var(--ink);}
.row-expanded-detail td{padding:0;background:#f8faff;border-bottom:2px solid var(--border2);}
.expand-panel{padding:16px 20px;display:grid;grid-template-columns:1fr 1fr;gap:20px;}
.expand-section h4{font-family:'Syne',sans-serif;font-size:10px;font-weight:700;letter-spacing:.5px;margin-bottom:8px;display:flex;align-items:center;gap:6px;}
.expand-section h4.ums{color:var(--blue);}
.expand-section h4.otm{color:var(--teal);}
.expand-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px;}
.expand-field{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:6px 10px;}
.expand-field.diff{border-color:#fcd34d;background:#fffdf0;}
.expand-field-label{font-size:9px;letter-spacing:.5px;color:var(--ink4);margin-bottom:2px;}
.expand-field-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:500;}
.expand-field.diff .expand-field-val{color:var(--amber);}
.btn-sm{display:inline-flex;align-items:center;gap:5px;padding:5px 11px;border-radius:6px;font-size:11px;font-weight:600;cursor:pointer;border:1px solid var(--border);background:var(--surface);color:var(--ink2);font-family:'Figtree',sans-serif;transition:all .15s;}
.btn-sm:hover{background:var(--surface2);}
.btn-sm.primary{background:var(--blue);color:#fff;border-color:var(--blue);}
</style>
</head>
<body>
<div class="app">

<!-- ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ -->
<nav class="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">LEA<span>P</span></div>
    <div class="sb-logo-sub">Logistics Execution and Acceleration Platform</div>
  </div>
  <div class="sb-section">
    <div class="sb-module-header">
      <span class="sb-module-icon">üì¶</span>
      <span class="sb-module-label">FreightPay Console</span>
      <div class="sb-module-divider"></div>
    </div>
    <div class="sb-item active" onclick="nav('search')" id="nav-search">
      <span class="sb-icon">üîç</span> Shipment Lookup
    </div>
    <div class="sb-item" onclick="nav('ums')" id="nav-ums">
      <span class="sb-icon">‚öñÔ∏è</span> UMS Reconciliation
    </div>
  </div>
  <div class="sb-bottom">
    <div class="sb-settings"><span style="font-size:13px;">‚öôÔ∏è</span> Settings</div>
  </div>
</nav>

<!-- ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ -->
<div class="main">
  <div class="topbar">
    <span class="topbar-module" id="topbar-module">FreightPay Console</span>
    <span class="topbar-sep">‚Ä∫</span>
    <div class="topbar-title" id="topbar-title">Shipment Lookup</div>
    <div class="topbar-actions">
      <div class="api-status checking" id="api-status">
        <span class="spinner spinner-dark" style="width:9px;height:9px;border-top-color:var(--amber);"></span>
        Checking OTM...
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ PAGE: SHIPMENT LOOKUP ‚îÄ‚îÄ -->
  <div class="page active" id="page-search">
    <div class="page-head">
      <h1>Shipment Lookup</h1>
      <p>Enter one value or multiple comma-separated values. Results are grouped per value when searching in bulk.</p>
    </div>
    <div class="search-bar">
      <div style="display:flex;gap:8px;align-items:flex-start;">
        <div style="flex:1;">
          <textarea class="input" id="search-input" rows="2"
            style="resize:vertical;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;"
            placeholder="e.g. 3563932506  or  3563932506, 3563926053, 3563889852"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();doSearch();}"></textarea>
          <div style="margin-top:5px;font-size:10px;color:var(--ink4);" id="search-hint">
            Press Enter to search ¬∑ Separate multiple values with commas
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn btn-primary" id="search-btn" onclick="doSearch()">Search OTM</button>
          <button class="btn" style="background:var(--surface2);color:var(--ink3);border:1px solid var(--border2);font-size:11px;" onclick="clearSearch()">Clear</button>
        </div>
      </div>
    </div>

    <div id="refresh-bar" style="display:none;align-items:center;gap:10px;background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;padding:9px 14px;margin-bottom:12px;font-size:12px;color:var(--blue);">
      <span>‚úÖ Action sent to OTM successfully. Dependent workflows may still be running.</span>
      <button class="btn btn-primary" style="padding:5px 14px;font-size:11px;margin-left:auto;" onclick="doSearch();hideRefreshBar();">‚Üª Refresh Results</button>
    </div>
    <div id="search-error" class="error-banner" style="display:none;"><span>‚ö†</span><div id="search-error-text"></div></div>
    <div class="state-box" id="search-empty">
      <div class="icon">üîç</div>
      <h3>Enter a value to search</h3>
      <p>Single value or comma-separated list ‚Äî the tool handles both automatically</p>
    </div>
    <div class="state-box" id="search-loading" style="display:none;">
      <div class="spinner spinner-dark" style="width:26px;height:26px;margin:0 auto 10px;"></div>
      <h3 id="search-loading-text">Querying OTM...</h3>
      <p id="search-loading-sub">Fetching results</p>
    </div>
    <div id="search-results" style="display:none;">
      <div class="result-meta" id="result-meta"></div>
      <div class="card" style="margin-bottom:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Shipment Id</th><th>Name</th><th>Order No.</th><th>Type</th><th>Src</th><th>Mode</th><th>Carrier</th>
                <th>Origin</th><th>Dest</th><th>Start</th><th>Weight</th><th>Cost (USD)</th>
                <th class="status-col">BTF Elig</th><th class="status-col">BTF Pricing</th>
                <th class="status-col">USB Status</th>
                <th class="fp-col">FP Status</th><th class="action-col">Actions</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>
    </div>
    <div id="bulk-results" style="display:none;"></div>
  </div>

  <!-- ‚îÄ‚îÄ PAGE: UMS RECONCILIATION ‚îÄ‚îÄ -->
  <div class="page" id="page-ums">
    <div class="page-head">
      <h1>UMS Reconciliation</h1>
      <p>Upload the weekly USB unmatched shipment sheet and cross-reference against OTM to surface discrepancies.</p>
    </div>

    <!-- Upload zone -->
    <div class="upload-zone" id="upload-zone" onclick="document.getElementById('ums-file-input').click()">
      <div class="upload-icon" id="upload-icon">üìÇ</div>
      <div class="upload-text">
        <h3 id="upload-title">Drop UMS sheet here or click to upload</h3>
        <p id="upload-sub">Accepts .xlsx or .csv ¬∑ Columns A‚ÄìAM expected</p>
      </div>
      <div class="upload-actions" id="upload-actions"></div>
      <input type="file" id="ums-file-input" accept=".xlsx,.csv" style="display:none;" onchange="handleFileUpload(this)">
    </div>

    <!-- Config row -->
    <div class="config-row">
      <span class="config-label">Priority By</span>
      <div class="toggle-group">
        <button class="toggle-opt active" onclick="setToggle(this,'sort')">üî¥ Age (Oldest First)</button>
        <button class="toggle-opt" onclick="setToggle(this,'sort')">üìÖ Financial Status Date</button>
        <button class="toggle-opt" onclick="setToggle(this,'sort')">‚úèÔ∏è Custom</button>
      </div>
      <div class="config-divider"></div>
      <span class="config-label">Rows To Search</span>
      <div class="toggle-group">
        <button class="toggle-opt active" onclick="setToggle(this,'rows')">Top 10</button>
        <button class="toggle-opt" onclick="setToggle(this,'rows')">Top 25</button>
        <button class="toggle-opt" onclick="setToggle(this,'rows')">Top 50</button>
        <button class="toggle-opt" onclick="setToggle(this,'rows')">All</button>
      </div>
      <div class="config-divider"></div>
      <span class="config-label">Search Key</span>
      <div class="toggle-group">
        <button class="toggle-opt active" onclick="setToggle(this,'key')">Both (Order + PO)</button>
        <button class="toggle-opt" onclick="setToggle(this,'key')">Order No. Only</button>
        <button class="toggle-opt" onclick="setToggle(this,'key')">PO No. Only</button>
      </div>
      <button class="run-btn" id="run-recon-btn" onclick="runReconciliation()" disabled>‚ñ∂ Run Reconciliation</button>
    </div>

    <!-- Progress -->
    <div class="progress-wrap" id="ums-progress">
      <div class="progress-header">
        <span class="progress-label" id="ums-progress-label">üîÑ Searching OTM...</span>
        <span class="progress-count" id="ums-progress-count">0 / 0</span>
      </div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="ums-progress-fill" style="width:0%"></div>
      </div>
      <div class="progress-steps" id="ums-progress-steps"></div>
    </div>

    <!-- Summary cards -->
    <div class="summary-grid" id="ums-summary" style="display:none;">
      <div class="sum-card hl-red">
        <div class="sum-icon" style="background:var(--red-lt);">üî¥</div>
        <div><div class="sum-val" style="color:var(--red);" id="sum-not-found">‚Äî</div><div class="sum-lbl">Not Found in OTM</div></div>
      </div>
      <div class="sum-card hl-amber">
        <div class="sum-icon" style="background:var(--amber-lt);">üü°</div>
        <div><div class="sum-val" style="color:var(--amber);" id="sum-mismatch">‚Äî</div><div class="sum-lbl">Cost Mismatch</div></div>
      </div>
      <div class="sum-card hl-green">
        <div class="sum-icon" style="background:var(--green-lt);">üü¢</div>
        <div><div class="sum-val" style="color:var(--green);" id="sum-matched">‚Äî</div><div class="sum-lbl">Matched Clean</div></div>
      </div>
      <div class="sum-card hl-orange">
        <div class="sum-icon" style="background:var(--orange-lt);">‚ö†Ô∏è</div>
        <div><div class="sum-val" style="color:var(--orange);" id="sum-critical">‚Äî</div><div class="sum-lbl">Critical Aged (&gt;180 days)</div></div>
      </div>
    </div>

    <!-- Results table -->
    <div class="card" id="ums-results-card" style="display:none;">
      <div class="card-header">
        <span style="font-size:13px;">‚öñÔ∏è</span>
        <span class="card-title" id="ums-results-title">Reconciliation Results</span>
        <div style="margin-left:auto;display:flex;gap:8px;">
          <button class="btn-sm primary" onclick="exportUmsResults()">‚¨á Export Excel</button>
        </div>
      </div>
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:28px;"></th>
              <th>Age</th>
              <th class="ums-col">Document No.</th>
              <th class="ums-col">Order No.</th>
              <th class="ums-col">PO Number</th>
              <th class="ums-col">Billed Amt</th>
              <th class="ums-col">Issue Date</th>
              <th class="otm-col">OTM Match</th>
              <th class="otm-col">OTM Shipment Id</th>
              <th class="otm-col">OTM Cost</th>
              <th class="diff-col">Cost Œî</th>
              <th class="otm-col">BTF Status</th>
              <th class="otm-col">FP Status</th>
              <th class="action-col">Actions</th>
            </tr>
          </thead>
          <tbody id="ums-results-body"></tbody>
        </table>
      </div>
    </div>

    <!-- Empty state -->
    <div class="state-box" id="ums-empty">
      <div class="icon">‚öñÔ∏è</div>
      <h3>No file uploaded yet</h3>
      <p>Upload the weekly UMS sheet to begin reconciliation</p>
    </div>

  </div><!-- end page-ums -->

</div><!-- end main -->
</div><!-- end app -->

<!-- ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ -->
<div class="overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon" id="modal-icon">‚ö°</div>
      <div>
        <div class="modal-title" id="modal-title">‚Äî</div>
        <div class="modal-sub" id="modal-sub">‚Äî</div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-detail">
        <div class="modal-row">
          <span class="modal-lbl">Shipment Id</span>
          <span class="modal-val" id="modal-xid">‚Äî</span>
        </div>
        <div class="modal-row">
          <span class="modal-lbl">Carrier</span>
          <span class="modal-val" id="modal-carrier">‚Äî</span>
        </div>
        <div class="modal-row" id="modal-extra-row">
          <span class="modal-lbl" id="modal-extra-lbl">‚Äî</span>
          <span class="modal-val" id="modal-extra-val">‚Äî</span>
        </div>
      </div>
      <div class="modal-warning" id="modal-warning">
        <span>‚ö†Ô∏è</span>
        <div id="modal-warning-text">‚Äî</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button id="modal-confirm-btn" onclick="confirmAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- BTF ERROR MODAL -->
<div class="overlay" id="btf-error-overlay" onclick="if(event.target===this)closeBtfError()" style="z-index:110;">
  <div class="modal" style="width:480px;">
    <div class="modal-header">
      <div class="modal-icon" style="background:#fee2e2;">‚ö†Ô∏è</div>
      <div>
        <div class="modal-title">BTF Pricing Error</div>
        <div class="modal-sub" id="btf-error-xid">‚Äî</div>
      </div>
    </div>
    <div class="modal-body">
      <div style="background:#fef2f2;border:1px solid #fca5a5;border-radius:8px;padding:12px 14px;font-size:12px;color:#b91c1c;line-height:1.6;word-break:break-word;" id="btf-error-text">‚Äî</div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeBtfError()">Close</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const API = '';
let pendingAction = null;
const actionsInFlight = new Set();
let umsRows = []; // parsed UMS data

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
const PAGE_TITLES = {
  search: 'Shipment Lookup',
  ums:    'UMS Reconciliation'
};

function nav(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  const ni = document.getElementById('nav-' + page);
  if (ni) ni.classList.add('active');
  document.getElementById('topbar-title').textContent = PAGE_TITLES[page] || page;
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
function clearSearch() {
  document.getElementById('search-input').value = '';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('bulk-results').style.display = 'none';
  document.getElementById('bulk-results').innerHTML = '';
  document.getElementById('search-empty').style.display = 'block';
  document.getElementById('search-error').style.display = 'none';
}

async function doSearch() {
  const raw = document.getElementById('search-input').value.trim();
  if (!raw) { alert('Please enter a search value.'); return; }

  const vals = [...new Set(raw.split(',').map(v => v.trim()).filter(Boolean))];
  const isBulk = vals.length > 1;

  hideRefreshBar();
  document.getElementById('search-empty').style.display = 'none';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('bulk-results').style.display = 'none';
  document.getElementById('bulk-results').innerHTML = '';
  document.getElementById('search-error').style.display = 'none';
  document.getElementById('search-loading').style.display = 'block';
  document.getElementById('search-loading-text').textContent = isBulk
    ? `Querying OTM for ${vals.length} values...` : 'Querying OTM...';
  document.getElementById('search-loading-sub').textContent = isBulk
    ? 'Results will be grouped per value' : 'Fetching results';

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Searching...';

  try {
    if (isBulk) {
      if (vals.length > 100) throw new Error('Maximum 100 values per request.');
      const resp = await fetch(`${API}/api/bulk-search`, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: vals.join(',')
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);
      renderBulkResults(data);
    } else {
      const resp = await fetch(`${API}/api/search?q=${encodeURIComponent(vals[0])}`);
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);
      renderResults(data);
    }
  } catch (err) {
    document.getElementById('search-error-text').textContent = `Error: ${err.message}`;
    document.getElementById('search-error').style.display = 'flex';
  } finally {
    document.getElementById('search-loading').style.display = 'none';
    btn.disabled = false;
    btn.innerHTML = 'Search OTM';
  }
}

// ‚îÄ‚îÄ CELL HELPERS ‚îÄ‚îÄ
function stCell(value, errorMsg, xid) {
  if (!value) return `<td><span class="st st-null">‚Äî</span></td>`;
  const v = value.toUpperCase();
  let cls = 'st-null';
  if (['Y','PRICED','PROCESSED','SENT'].includes(v)) cls = 'st-ok';
  else if (['N','NOT_PROCESSED','REPROCESS'].includes(v)) cls = 'st-warn';
  else if (['ERROR','HOLD'].includes(v)) cls = 'st-err';
  if (v === 'ERROR' && errorMsg && xid) {
    const safeMsg = errorMsg.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    const safeXid = xid.replace(/'/g, "\\'");
    return `<td><span class="st ${cls}" style="cursor:pointer;text-decoration:underline dotted;" title="Click to see error details" onclick="openBtfError('${safeXid}','${safeMsg}')">‚ö† Error</span></td>`;
  }
  return `<td><span class="st ${cls}">${value}</span></td>`;
}

function fpStatusCell(isFP, attr10) {
  if (!isFP) return `<td><span class="st st-null">‚Äî</span></td>`;
  const isEmpty = attr10 === null || attr10 === undefined || attr10 === '';
  return isEmpty
    ? `<td><span class="st st-null">‚Äî</span></td>`
    : `<td><span class="st st-err" title="${attr10}">${attr10}</span></td>`;
}

// ‚îÄ‚îÄ ACTION CELL ‚îÄ‚îÄ
// siblings = array of all shipments in the same search result group
// Used to suppress "Send to PO" on TOC rows when a clean FP sibling already exists
function actionCell(s, siblings) {
  const isFP    = s.shipmentAsWork;
  const isTL    = (s.transportMode || '').toUpperCase() === 'TL';
  const st      = s.statuses || {};
  const xid     = s.shipmentXid;
  const carrier = (s.carrier || '‚Äî').replace(/'/g, "\\'");
  const attr10  = s.attribute10;
  const fpBlocked = attr10 !== null && attr10 !== undefined && attr10 !== '';

  if (isFP) {
    const btfElig   = (st.BTF_SHIP_IND?.value     || '').toUpperCase();
    const btfPrice  = (st.BTF_RATE_IND?.value      || '').toUpperCase();
    const usbStatus = (st.SENT_TO_USB?.value        || '').toUpperCase();

    // BTF Trigger ‚Äî TL only
    if (isTL && btfElig === 'Y' && btfPrice === 'NOT_PROCESSED') {
      return `<td><button class="btn-btf" id="action-btn-${xid}" onclick="openModal('btf','${xid}','${carrier}',this)">‚ö° Trigger BTF</button></td>`;
    }
    if (isTL && btfPrice === 'REPROCESS') {
      return `<td><button class="btn-btf" disabled style="opacity:0.45;cursor:not-allowed;">‚è≥ Awaiting BTF...</button></td>`;
    }
    // USB Trigger ‚Äî NOT_PROCESSED or ERROR
    const usbEligible = usbStatus === 'NOT_PROCESSED' || usbStatus === 'ERROR';
    const usbLtlReady = !isTL && usbEligible && !fpBlocked;
    const usbTlReady  = isTL && btfPrice === 'PRICED' && usbEligible && !fpBlocked;
    if (usbLtlReady || usbTlReady) {
      const label = usbStatus === 'ERROR' ? 'üì° Retry USB' : 'üì° Trigger USB';
      return `<td><button class="btn-usb" id="action-btn-${xid}" onclick="openModal('usb','${xid}','${carrier}',this)">${label}</button></td>`;
    }
    if (btfPrice === 'PRICED' || usbStatus === 'SENT' || usbStatus === 'PROCESSED') {
      return `<td><span class="st st-ok" style="font-size:10px;">‚úì ${usbStatus === 'SENT' ? 'Sent' : usbStatus === 'PROCESSED' ? 'Processed' : 'Priced'}</span></td>`;
    }
    if (btfPrice === 'ERROR') {
      const safeMsg = (s.btfErrorMessage || 'No error details available.').replace(/'/g, "\\'");
      const safeXid = xid.replace(/'/g, "\\'");
      return `<td><span class="st st-err" style="font-size:10px;cursor:pointer;text-decoration:underline dotted;" onclick="openBtfError('${safeXid}','${safeMsg}')">‚ö† BTF Error</span></td>`;
    }
    if (btfPrice === 'HOLD' || usbStatus === 'HOLD') {
      return `<td><span class="st st-warn" style="font-size:10px;">‚è∏ Hold</span></td>`;
    }
    return `<td><span class="st st-null">‚Äî</span></td>`;
  } else {
    // Send to PO ‚Äî TOC only
    // Suppress if a clean FP sibling already exists in the same result group
    // A clean FP sibling = shipmentAsWork:true AND (SENT_TO_USB = SENT/PROCESSED OR attribute10 = null)
    const siblings_ = siblings || [];
    const fpSiblingExists = siblings_.some(sib => {
      if (!sib.shipmentAsWork || sib.shipmentXid === xid) return false;
      const sibAttr10 = sib.attribute10;
      const sibUsbStatus = (sib.statuses?.SENT_TO_USB?.value || '').toUpperCase();
      const sibClean = (sibAttr10 === null || sibAttr10 === undefined || sibAttr10 === '')
                    || sibUsbStatus === 'SENT'
                    || sibUsbStatus === 'PROCESSED';
      return sibClean;
    });
    if (fpSiblingExists) {
      return `<td><span class="st st-null" title="FP shipment already exists for this order">‚Äî</span></td>`;
    }
    const attrNum1 = s.attributeNumber1;
    const eligible = attrNum1 === null || attrNum1 === undefined || attrNum1 === '' || String(attrNum1) === '2';
    if (eligible) {
      return `<td><button class="btn-po" id="action-btn-${xid}" onclick="openModal('po','${xid}','${carrier}',this)">üì§ Send to PO</button></td>`;
    }
    return `<td><span class="st st-null">‚Äî</span></td>`;
  }
}

function renderResults(data) {
  document.getElementById('search-results').style.display = 'block';
  const meta = document.getElementById('result-meta');
  meta.innerHTML = `<span style="font-size:12px;font-weight:600;color:var(--ink3);">${data.totalCount} shipment${data.totalCount!==1?'s':''} found</span>
    <span style="font-size:11px;color:var(--ink4);">¬∑ Live from OTM</span>`;

  const tbody = document.getElementById('results-body');
  if (!data.items || data.items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="17" style="text-align:center;padding:28px;color:var(--ink4);">No shipments found.</td></tr>`;
    return;
  }
  tbody.innerHTML = data.items.map(s => buildShipmentRow(s, data.items)).join('');
}

function buildShipmentRow(s, siblings) {
  const isFP = s.shipmentAsWork;
  const startDate = s.startTime ? s.startTime.split('T')[0] : '‚Äî';
  const weight = s.totalWeight != null ? `${Number(s.totalWeight).toLocaleString()} ${s.weightUnit||''}` : '‚Äî';
  const cost = s.totalActualCost != null
    ? `$${Number(s.totalActualCost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}` : '‚Äî';
  const typeChip = isFP ? `<span class="chip chip-teal">FP</span>` : `<span class="chip chip-gray">TOC</span>`;
  const rowCls = isFP ? 'row-fp' : '';
  const st = s.statuses || {};
  let srcChip = `<span class="st st-null">‚Äî</span>`;
  if (s.dataSource) {
    const dc = s.dataSource.toUpperCase().includes('SAP') ? 'chip-amber' : 'chip-blue';
    srcChip = `<span class="chip ${dc}">${s.dataSource}</span>`;
  }
  const btfElig  = isFP ? stCell(st.BTF_SHIP_IND?.value) : `<td><span class="st st-null">‚Äî</span></td>`;
  const btfPrice = isFP ? stCell(st.BTF_RATE_IND?.value, s.btfErrorMessage, s.shipmentXid) : `<td><span class="st st-null">‚Äî</span></td>`;
  const usbSt    = isFP ? stCell(st.SENT_TO_USB?.value) : `<td><span class="st st-null">‚Äî</span></td>`;
  const fpSt     = fpStatusCell(isFP, s.attribute10);
  const action   = actionCell(s, siblings || []);
  return `<tr class="${rowCls}">
    <td class="mono" style="color:var(--blue);font-weight:600;font-size:11px;">${s.shipmentXid||'‚Äî'}</td>
    <td class="mono">${s.shipmentName||'‚Äî'}</td>
    <td class="mono" style="font-size:11px;">${s.orderNumber||'‚Äî'}</td>
    <td>${typeChip}</td><td>${srcChip}</td>
    <td><span class="chip chip-gray">${s.transportMode||'‚Äî'}</span></td>
    <td style="font-weight:500;">${s.carrier||'‚Äî'}</td>
    <td class="mono" style="font-size:10px;">${s.sourceLocation||'‚Äî'}</td>
    <td class="mono" style="font-size:10px;">${s.destLocation||'‚Äî'}</td>
    <td style="color:var(--ink3);">${startDate}</td>
    <td>${weight}</td>
    <td style="font-weight:600;">${cost}</td>
    ${btfElig}${btfPrice}${usbSt}${fpSt}${action}
  </tr>`;
}

// ‚îÄ‚îÄ BULK RENDER ‚îÄ‚îÄ
function renderBulkResults(data) {
  const container = document.getElementById('bulk-results');
  container.style.display = 'block';
  const found    = data.results.filter(r => r.totalCount > 0).length;
  const notFound = data.results.filter(r => r.totalCount === 0).length;
  const errors   = data.results.filter(r => r.errors && r.errors.length > 0).length;
  let html = `<div class="bulk-summary-bar">
    <span>üîç <strong>${data.totalValues}</strong> values searched</span>
    <span>üì¶ <strong>${data.totalShipments}</strong> total shipments found</span>
    <span style="color:var(--green);">‚úì <strong>${found}</strong> with results</span>
    ${notFound ? `<span style="color:var(--ink4);">‚óã <strong>${notFound}</strong> no results</span>` : ''}
    ${errors   ? `<span style="color:var(--red);">‚ö† <strong>${errors}</strong> errors</span>` : ''}
  </div>`;

  data.results.forEach((group, idx) => {
    const hasResults = group.totalCount > 0;
    const hasError   = group.errors && group.errors.length > 0;
    const countCls   = hasError ? 'error' : hasResults ? 'found' : 'none';
    const countLbl   = hasError ? '‚ö† Error' : hasResults ? `${group.totalCount} found` : 'No results';
    let rowsHtml = '';
    if (!hasResults) {
      rowsHtml = `<tr><td colspan="17" style="text-align:center;padding:20px;color:var(--ink4);font-size:12px;">
        ${hasError ? `‚ö† ${group.errors[0]}` : 'No shipments found for this value.'}</td></tr>`;
    } else {
      rowsHtml = group.items.map(s => buildShipmentRow(s, group.items)).join('');
    }
    html += `<div class="bulk-group" id="bulk-group-${idx}">
      <div class="bulk-group-header" onclick="toggleBulkGroup(${idx})">
        <span class="bulk-group-xid">${group.searchValue}</span>
        <span class="bulk-group-count ${countCls}">${countLbl}</span>
        <span class="bulk-group-toggle">‚ñº</span>
      </div>
      <div class="bulk-group-body">
        <div class="table-wrap"><table>
          <thead><tr>
            <th>Shipment Id</th><th>Name</th><th>Order No.</th><th>Type</th><th>Src</th><th>Mode</th><th>Carrier</th>
            <th>Origin</th><th>Dest</th><th>Start</th><th>Weight</th><th>Cost (USD)</th>
            <th class="status-col">BTF Elig</th><th class="status-col">BTF Pricing</th>
            <th class="status-col">USB Status</th>
            <th class="fp-col">FP Status</th><th class="action-col">Actions</th>
          </tr></thead>
          <tbody>${rowsHtml}</tbody>
        </table></div>
      </div>
    </div>`;
  });
  container.innerHTML = html;
}

function toggleBulkGroup(idx) {
  document.getElementById(`bulk-group-${idx}`).classList.toggle('collapsed');
}

// ‚îÄ‚îÄ UMS RECONCILIATION ‚îÄ‚îÄ
function setToggle(el, group) {
  el.closest('.toggle-group').querySelectorAll('.toggle-opt').forEach(b => b.classList.remove('active'));
  el.classList.add('active');
}

function handleFileUpload(input) {
  const file = input.files[0];
  if (!file) return;
  const zone = document.getElementById('upload-zone');
  zone.classList.add('has-file');
  document.getElementById('upload-icon').textContent = '‚úÖ';
  document.getElementById('upload-title').textContent = file.name;
  document.getElementById('upload-sub').textContent = `${(file.size/1024).toFixed(0)} KB ¬∑ Ready to process`;
  document.getElementById('upload-actions').innerHTML = `<button class="btn-sm" onclick="event.stopPropagation();resetUpload()">‚Ü∫ Replace</button>`;
  document.getElementById('run-recon-btn').disabled = false;
  // Store file reference for processing
  window._umsFile = file;
}

function resetUpload() {
  const zone = document.getElementById('upload-zone');
  zone.classList.remove('has-file');
  document.getElementById('upload-icon').textContent = 'üìÇ';
  document.getElementById('upload-title').textContent = 'Drop UMS sheet here or click to upload';
  document.getElementById('upload-sub').textContent = 'Accepts .xlsx or .csv ¬∑ Columns A‚ÄìAM expected';
  document.getElementById('upload-actions').innerHTML = '';
  document.getElementById('run-recon-btn').disabled = true;
  document.getElementById('ums-summary').style.display = 'none';
  document.getElementById('ums-results-card').style.display = 'none';
  document.getElementById('ums-empty').style.display = 'block';
  document.getElementById('ums-file-input').value = '';
  window._umsFile = null;
  umsRows = [];
}

async function runReconciliation() {
  if (!window._umsFile) { showToast('Please upload a UMS file first', 'err'); return; }

  const sortMode = document.querySelector('.toggle-group .toggle-opt.active[onclick*="sort"]')?.textContent || '';
  const rowsMode = document.querySelector('.toggle-group .toggle-opt.active[onclick*="rows"]')?.textContent || 'Top 10';
  const rowLimit = rowsMode.includes('10') ? 10 : rowsMode.includes('25') ? 25 : rowsMode.includes('50') ? 50 : 9999;

  document.getElementById('ums-empty').style.display = 'none';
  document.getElementById('ums-summary').style.display = 'none';
  document.getElementById('ums-results-card').style.display = 'none';
  document.getElementById('run-recon-btn').disabled = true;

  // Show progress
  const progressWrap = document.getElementById('ums-progress');
  progressWrap.classList.add('visible');

  try {
    // Parse file
    document.getElementById('ums-progress-label').textContent = 'üìÇ Parsing UMS file...';
    const rows = await parseUmsFile(window._umsFile);
    if (!rows || rows.length === 0) throw new Error('No data rows found in file.');

    // Sort
    let sorted = [...rows];
    if (sortMode.includes('Age')) {
      sorted.sort((a, b) => (b.age || 0) - (a.age || 0));
    } else if (sortMode.includes('Financial')) {
      sorted.sort((a, b) => new Date(b.financialStatusDate) - new Date(a.financialStatusDate));
    }
    const selected = sorted.slice(0, rowLimit);

    // Search OTM in batches of 100
    const searchKey = document.querySelector('.toggle-group .toggle-opt.active[onclick*="key"]')?.textContent || '';
    const useOrder = !searchKey.includes('PO No. Only');
    const usePO    = !searchKey.includes('Order No. Only');

    const searchValues = [...new Set(selected.flatMap(r => {
      const vals = [];
      if (useOrder && r.orderNumber) vals.push(r.orderNumber);
      if (usePO && r.poNumber && r.poNumber !== 'NS') vals.push(r.poNumber);
      return vals;
    }))];

    const BATCH_SIZE = 100;
    const batches = [];
    for (let i = 0; i < searchValues.length; i += BATCH_SIZE) {
      batches.push(searchValues.slice(i, i + BATCH_SIZE));
    }

    // Build steps UI
    const stepsEl = document.getElementById('ums-progress-steps');
    stepsEl.innerHTML = batches.map((_, i) =>
      `<span class="progress-step pending" id="ums-step-${i}">Batch ${i+1}</span>`
    ).join('');

    // Execute batches
    const otmMap = {};
    for (let i = 0; i < batches.length; i++) {
      document.getElementById('ums-progress-label').textContent = `üîÑ Searching OTM ‚Äî Batch ${i+1} of ${batches.length}`;
      document.getElementById('ums-progress-count').textContent = `${i * BATCH_SIZE} / ${searchValues.length} values`;
      document.getElementById(`ums-step-${i}`).className = 'progress-step active';
      const pct = Math.round((i / batches.length) * 100);
      document.getElementById('ums-progress-fill').style.width = pct + '%';

      const resp = await fetch(`${API}/api/bulk-search`, {
        method: 'POST', headers: { 'Content-Type': 'text/plain' }, body: batches[i].join(',')
      });
      const data = await resp.json();
      data.results.forEach(group => {
        if (group.items && group.items.length > 0) {
          otmMap[group.searchValue] = group.items[0]; // take first match
        }
      });
      document.getElementById(`ums-step-${i}`).className = 'progress-step done';
      if (i < batches.length - 1) document.getElementById(`ums-step-${i+1}`).className = 'progress-step active';
    }

    document.getElementById('ums-progress-fill').style.width = '100%';
    document.getElementById('ums-progress-label').textContent = '‚úÖ Reconciliation complete';
    document.getElementById('ums-progress-count').textContent = `${selected.length} / ${selected.length}`;

    // Reconcile
    const reconciled = selected.map(row => {
      const orderMatch = otmMap[row.orderNumber];
      const poMatch    = otmMap[row.poNumber];
      const otmShipment = orderMatch || poMatch || null;
      let matchStatus = 'not_found';
      let costDelta = null;
      if (otmShipment) {
        const otmCost = otmShipment.totalActualCost;
        if (otmCost !== null && otmCost !== undefined && row.billedAmount !== null) {
          costDelta = row.billedAmount - otmCost;
          matchStatus = Math.abs(costDelta) < 0.01 ? 'matched' : 'mismatch';
        } else {
          matchStatus = 'mismatch';
          costDelta = row.billedAmount;
        }
      }
      return { ...row, otmShipment, matchStatus, costDelta };
    });

    renderUmsResults(reconciled);
  } catch (err) {
    showToast(`‚ùå Error: ${err.message}`, 'err');
  } finally {
    document.getElementById('run-recon-btn').disabled = false;
    setTimeout(() => progressWrap.classList.remove('visible'), 2000);
  }
}

async function parseUmsFile(file) {
  // Load SheetJS dynamically if not already present
  if (typeof XLSX === 'undefined') {
    await new Promise((res, rej) => {
      const s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
      s.onload = res; s.onerror = rej;
      document.head.appendChild(s);
    });
  }

  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const isXlsx = file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls');

        if (isXlsx) {
          // ‚îÄ‚îÄ XLSX path via SheetJS ‚îÄ‚îÄ
          const data    = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, { type: 'array', cellDates: true });
          const sheet   = workbook.Sheets[workbook.SheetNames[0]];
          // Get raw rows as arrays (no header inference ‚Äî positional column mapping)
          const raw = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
          if (raw.length < 2) { resolve([]); return; }

          // Log header row to console for debugging column positions
          console.log('UMS Headers:', raw[0]);

          const rows = raw.slice(1).map(cols => {
            const documentNumber      = String(cols[0]  ?? '').trim();
            const orderNumber         = String(cols[1]  ?? '').trim();
            const financialStatusDate = String(cols[2]  ?? '').trim();
            const financialStatus     = String(cols[3]  ?? '').trim();
            const ageRaw              = cols[4];
            const age                 = typeof ageRaw === 'number' ? ageRaw : parseInt(ageRaw) || 0;
            const poNumber            = String(cols[6]  ?? '').trim();
            const issueDate           = String(cols[12] ?? '').trim();
            const billedRaw           = cols[14];
            const billedAmount        = typeof billedRaw === 'number' ? billedRaw : parseFloat(billedRaw) || null;
            return { documentNumber, orderNumber, financialStatusDate, financialStatus, age, poNumber, billedAmount, issueDate };
          }).filter(r => r.documentNumber && r.documentNumber !== '');

          resolve(rows);
        } else {
          // ‚îÄ‚îÄ CSV fallback ‚îÄ‚îÄ
          const text  = e.target.result;
          const lines = text.split('\n').filter(l => l.trim());
          if (lines.length < 2) { resolve([]); return; }
          const delim = lines[0].includes('\t') ? '\t' : ',';
          const rows  = lines.slice(1).map(line => {
            const cols = line.split(delim).map(c => c.trim().replace(/^"|"$/g, ''));
            return {
              documentNumber:      cols[0]  || '',
              orderNumber:         cols[1]  || '',
              financialStatusDate: cols[2]  || '',
              financialStatus:     cols[3]  || '',
              age:                 parseInt(cols[4]) || 0,
              poNumber:            cols[6]  || '',
              billedAmount:        parseFloat(cols[14]) || null,
              issueDate:           cols[12] || '',
            };
          }).filter(r => r.documentNumber);
          resolve(rows);
        }
      } catch(err) { reject(err); }
    };
    reader.onerror = reject;
    // Use ArrayBuffer for xlsx, text for csv
    if (file.name.toLowerCase().endsWith('.xlsx') || file.name.toLowerCase().endsWith('.xls')) {
      reader.readAsArrayBuffer(file);
    } else {
      reader.readAsText(file);
    }
  });
}

function renderUmsResults(rows) {
  // Summary counts
  const notFound = rows.filter(r => r.matchStatus === 'not_found').length;
  const mismatch = rows.filter(r => r.matchStatus === 'mismatch').length;
  const matched  = rows.filter(r => r.matchStatus === 'matched').length;
  const critical = rows.filter(r => r.age > 180).length;

  document.getElementById('sum-not-found').textContent = notFound;
  document.getElementById('sum-mismatch').textContent  = mismatch;
  document.getElementById('sum-matched').textContent   = matched;
  document.getElementById('sum-critical').textContent  = critical;
  document.getElementById('ums-summary').style.display = 'grid';

  document.getElementById('ums-results-title').textContent =
    `Reconciliation Results ‚Äî ${rows.length} rows`;

  const tbody = document.getElementById('ums-results-body');
  tbody.innerHTML = rows.map((row, idx) => {
    const ageCls = row.age > 180 ? 'age-critical' : row.age > 90 ? 'age-warn' : 'age-ok';
    const rowCls = row.matchStatus === 'not_found' ? 'row-not-found'
                 : row.matchStatus === 'mismatch'  ? 'row-mismatch'
                 : 'row-matched';
    const matchChip = row.matchStatus === 'not_found'
      ? `<span class="chip chip-red">‚úó Not Found</span>`
      : row.matchStatus === 'mismatch'
      ? `<span class="chip chip-amber">‚ö† Mismatch</span>`
      : `<span class="chip chip-green">‚úì Matched</span>`;

    const otmXid = row.otmShipment ? `<span class="mono" style="color:var(--teal);font-weight:600;">${row.otmShipment.shipmentXid||'‚Äî'}</span>` : `<span class="st-null">‚Äî</span>`;
    const otmCost = row.otmShipment && row.otmShipment.totalActualCost != null
      ? `$${Number(row.otmShipment.totalActualCost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}`
      : '‚Äî';
    const billedFmt = row.billedAmount != null
      ? `$${Number(row.billedAmount).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}` : '‚Äî';
    const deltaTd = row.costDelta != null
      ? `<td style="font-weight:700;color:${Math.abs(row.costDelta)<0.01?'var(--green)':row.costDelta>0?'var(--amber)':'var(--red)'};">
          ${Math.abs(row.costDelta)<0.01?'$0.00':(row.costDelta>0?'+':'')+'$'+Math.abs(row.costDelta).toFixed(2)}
        </td>`
      : `<td class="st-null">‚Äî</td>`;

    const st = row.otmShipment?.statuses || {};
    const btfVal = st.BTF_RATE_IND?.value || '';
    const btfTd  = row.otmShipment ? stCell(btfVal) : `<td class="st-null">‚Äî</td>`;
    const fpTd   = row.otmShipment ? fpStatusCell(row.otmShipment.shipmentAsWork, row.otmShipment.attribute10) : `<td class="st-null">‚Äî</td>`;

    let actionTd = `<td><button class="btn-sm" style="font-size:10px;" onclick="searchFromUms('${row.orderNumber}','${row.poNumber}')">üîç Lookup</button></td>`;
    if (row.otmShipment) {
      actionTd = `<td>${actionCell(row.otmShipment).replace('<td>','').replace('</td>','')}</td>`;
    }

    return `<tr class="${rowCls}" id="ums-row-${idx}">
      <td><button class="expand-btn" onclick="toggleUmsExpand(${idx})">‚ñ∂</button></td>
      <td><span class="age-badge ${ageCls}">${row.age}d</span></td>
      <td class="mono" style="color:var(--blue);font-weight:600;">${row.documentNumber||'‚Äî'}</td>
      <td class="mono">${row.orderNumber||'‚Äî'}</td>
      <td class="mono">${row.poNumber||'‚Äî'}</td>
      <td style="font-weight:600;">${billedFmt}</td>
      <td style="color:var(--ink3);">${row.issueDate||'‚Äî'}</td>
      <td>${matchChip}</td>
      <td>${otmXid}</td>
      <td style="font-weight:600;color:var(--teal);">${otmCost}</td>
      ${deltaTd}${btfTd}${fpTd}${actionTd}
    </tr>
    <tr class="row-expanded-detail" id="ums-expand-${idx}" style="display:none;">
      <td colspan="14">${buildUmsExpandPanel(row)}</td>
    </tr>`;
  }).join('');

  document.getElementById('ums-results-card').style.display = 'block';
  document.getElementById('ums-empty').style.display = 'none';
}

function buildUmsExpandPanel(row) {
  const otm = row.otmShipment;
  const otmSection = otm ? `
    <div class="expand-grid">
      <div class="expand-field"><div class="expand-field-label">Shipment Id</div><div class="expand-field-val">${otm.shipmentXid||'‚Äî'}</div></div>
      <div class="expand-field"><div class="expand-field-label">Carrier</div><div class="expand-field-val">${otm.carrier||'‚Äî'}</div></div>
      <div class="expand-field ${row.costDelta && Math.abs(row.costDelta)>0.01?'diff':''}">
        <div class="expand-field-label">OTM Cost${row.costDelta && Math.abs(row.costDelta)>0.01?' ‚ö†':''}</div>
        <div class="expand-field-val">$${Number(otm.totalActualCost||0).toFixed(2)}</div>
      </div>
      <div class="expand-field"><div class="expand-field-label">Transport Mode</div><div class="expand-field-val">${otm.transportMode||'‚Äî'}</div></div>
      <div class="expand-field"><div class="expand-field-label">BTF Pricing</div><div class="expand-field-val">${otm.statuses?.BTF_RATE_IND?.value||'‚Äî'}</div></div>
      <div class="expand-field"><div class="expand-field-label">USB Status</div><div class="expand-field-val">${otm.statuses?.SENT_TO_USB?.value||'‚Äî'}</div></div>
    </div>` : `<div style="background:var(--red-lt);border:1px solid #fca5a5;border-radius:8px;padding:12px;text-align:center;color:var(--red);font-size:12px;font-weight:600;">
      ‚úó No shipment found in OTM for Order No. <strong>${row.orderNumber}</strong> or PO <strong>${row.poNumber}</strong>
    </div>`;

  return `<div class="expand-panel">
    <div class="expand-section">
      <h4 class="ums">üìÑ UMS Sheet Data</h4>
      <div class="expand-grid">
        <div class="expand-field"><div class="expand-field-label">Document No.</div><div class="expand-field-val">${row.documentNumber}</div></div>
        <div class="expand-field"><div class="expand-field-label">Order No.</div><div class="expand-field-val">${row.orderNumber}</div></div>
        <div class="expand-field"><div class="expand-field-label">PO Number</div><div class="expand-field-val">${row.poNumber}</div></div>
        <div class="expand-field ${row.costDelta && Math.abs(row.costDelta)>0.01?'diff':''}">
          <div class="expand-field-label">Billed Amount${row.costDelta && Math.abs(row.costDelta)>0.01?' ‚ö†':''}</div>
          <div class="expand-field-val">$${Number(row.billedAmount||0).toFixed(2)}</div>
        </div>
        <div class="expand-field"><div class="expand-field-label">Issue Date</div><div class="expand-field-val">${row.issueDate}</div></div>
        <div class="expand-field"><div class="expand-field-label">Age (Days)</div><div class="expand-field-val">${row.age}</div></div>
      </div>
    </div>
    <div class="expand-section">
      <h4 class="otm">üîó OTM Data</h4>
      ${otmSection}
    </div>
  </div>`;
}

function toggleUmsExpand(idx) {
  const detail = document.getElementById(`ums-expand-${idx}`);
  const btn    = document.querySelector(`#ums-row-${idx} .expand-btn`);
  const isOpen = detail.style.display !== 'none';
  detail.style.display = isOpen ? 'none' : 'table-row';
  btn.textContent = isOpen ? '‚ñ∂' : '‚ñº';
}

function searchFromUms(orderNo, poNo) {
  nav('search');
  const vals = [orderNo, poNo].filter(v => v && v !== 'NS').join(', ');
  document.getElementById('search-input').value = vals;
  doSearch();
}

function exportUmsResults() {
  showToast('Export feature ‚Äî requires SheetJS integration (coming soon)', 'ok');
}

// ‚îÄ‚îÄ REFRESH BAR ‚îÄ‚îÄ
function showRefreshBar() {
  const bar = document.getElementById('refresh-bar');
  if (bar) bar.style.display = 'flex';
}
function hideRefreshBar() {
  const bar = document.getElementById('refresh-bar');
  if (bar) bar.style.display = 'none';
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(type, xid, carrier, btnEl) {
  pendingAction = { type, xid, carrier, btnEl: btnEl || null };
  document.getElementById('modal-xid').textContent     = xid;
  document.getElementById('modal-carrier').textContent = carrier;

  if (type === 'btf') {
    document.getElementById('modal-icon').className    = 'modal-icon modal-icon-btf';
    document.getElementById('modal-icon').textContent  = '‚ö°';
    document.getElementById('modal-title').textContent = 'Trigger BTF Pricing';
    document.getElementById('modal-sub').textContent   = 'Send BTF reprocess request to OTM WMServlet';
    document.getElementById('modal-extra-lbl').textContent = 'Current BTF Pricing';
    document.getElementById('modal-extra-val').textContent = 'NOT_PROCESSED';
    document.getElementById('modal-extra-val').style.color = 'var(--amber)';
    document.getElementById('modal-warning').className = 'modal-warning modal-warning-btf';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger BTF fuel cost calculation. BTF_RATE_IND will be set to REPROCESS.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className = 'btn-confirm-btf'; btn.textContent = '‚ö° Confirm & Send';
  } else if (type === 'usb') {
    document.getElementById('modal-icon').className    = 'modal-icon modal-icon-usb';
    document.getElementById('modal-icon').textContent  = 'üì°';
    document.getElementById('modal-title').textContent = 'Trigger USB';
    document.getElementById('modal-sub').textContent   = 'Send SEND_SHIPMENT_USB - R to OTM WMServlet';
    document.getElementById('modal-extra-lbl').textContent = 'Status Value';
    document.getElementById('modal-extra-val').textContent = 'SEND_SHIPMENT_USB - R';
    document.getElementById('modal-extra-val').style.color = 'var(--teal)';
    document.getElementById('modal-warning').className = 'modal-warning modal-warning-usb';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger USB transmission. SENT_TO_USB will transition from NOT_PROCESSED or ERROR to the next state.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className = 'btn-confirm-usb'; btn.textContent = 'üì° Confirm & Send';
  } else {
    document.getElementById('modal-icon').className    = 'modal-icon modal-icon-po';
    document.getElementById('modal-icon').textContent  = 'üì§';
    document.getElementById('modal-title').textContent = 'Send to PO';
    document.getElementById('modal-sub').textContent   = 'Trigger FP shipment creation via OTM PO workflow';
    document.getElementById('modal-extra-lbl').textContent = 'Action';
    document.getElementById('modal-extra-val').textContent = 'SEND_SHIPMENT_PO - R';
    document.getElementById('modal-extra-val').style.color = 'var(--orange)';
    document.getElementById('modal-warning').className = 'modal-warning modal-warning-po';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger the Send to PO workflow. An FP shipment will be created with Data Source = OTM.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className = 'btn-confirm-po'; btn.textContent = 'üì§ Confirm & Send';
  }

  const confirmBtn = document.getElementById('modal-confirm-btn');
  confirmBtn.disabled = false;
  confirmBtn.style.pointerEvents = '';
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  pendingAction = null;
}

function openBtfError(xid, message) {
  document.getElementById('btf-error-xid').textContent  = xid;
  document.getElementById('btf-error-text').textContent = message || 'No error details available.';
  document.getElementById('btf-error-overlay').classList.add('open');
}

function closeBtfError() {
  document.getElementById('btf-error-overlay').classList.remove('open');
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

async function confirmAction() {
  if (!pendingAction) return;
  const type  = pendingAction.type;
  const xid   = pendingAction.xid;
  const btnEl = pendingAction.btnEl;
  if (actionsInFlight.has(xid)) return;
  actionsInFlight.add(xid);

  const confirmBtn = document.getElementById('modal-confirm-btn');
  confirmBtn.disabled = true;
  confirmBtn.style.pointerEvents = 'none';
  confirmBtn.innerHTML = '<span class="spinner"></span> Sending...';
  closeModal();

  if (btnEl) btnEl.outerHTML = `<span class="btn-sending" id="action-btn-${xid}"><span class="spinner spinner-dark" style="width:10px;height:10px;border-top-color:var(--ink3);"></span> Sending...</span>`;

  const endpoint = type === 'btf'
    ? `${API}/api/trigger-btf/${encodeURIComponent(xid)}`
    : type === 'usb'
    ? `${API}/api/trigger-usb/${encodeURIComponent(xid)}`
    : `${API}/api/send-to-po/${encodeURIComponent(xid)}`;

  const btnClass = type === 'btf' ? 'btn-btf' : type === 'usb' ? 'btn-usb' : 'btn-po';
  const btnLabel = type === 'btf' ? '‚ö° Retry' : type === 'usb' ? 'üì° Retry' : 'üì§ Retry';

  try {
    const resp = await fetch(endpoint, { method: 'POST' });
    const data = await resp.json();
    const btn  = document.getElementById(`action-btn-${xid}`);
    if (data.status === 'ok') {
      const label = type === 'btf' ? 'BTF trigger' : type === 'usb' ? 'USB trigger' : 'Send to PO';
      if (btn) btn.outerHTML = `<span class="btn-sent-ok">‚úÖ Sent</span>`;
      showToast(`‚úÖ ${label} sent for ${xid}`, 'ok');
      showRefreshBar();
    } else {
      if (btn) btn.outerHTML = `<button class="${btnClass}" id="action-btn-${xid}" onclick="openModal('${type}','${xid}','',this)">${btnLabel}</button>`;
      showToast(`‚ùå OTM returned HTTP ${data.httpStatus}`, 'err');
    }
  } catch (err) {
    const btn = document.getElementById(`action-btn-${xid}`);
    if (btn) btn.outerHTML = `<button class="${btnClass}" id="action-btn-${xid}" onclick="openModal('${type}','${xid}','',this)">${btnLabel}</button>`;
    showToast(`‚ùå Error: ${err.message}`, 'err');
  } finally {
    actionsInFlight.delete(xid);
  }
}

// ‚îÄ‚îÄ HEALTH CHECK ‚îÄ‚îÄ
async function checkHealth() {
  const el = document.getElementById('api-status');
  try {
    const resp = await fetch('/api/health', {signal: AbortSignal.timeout(8000)});
    const data = await resp.json();
    el.className = data.status === 'ok' ? 'api-status ok' : 'api-status err';
    el.innerHTML = data.status === 'ok' ? '‚óè OTM Connected' : '‚óè OTM Error';
  } catch {
    el.className = 'api-status err';
    el.innerHTML = '‚óè OTM Unreachable';
  }
}
checkHealth();
setInterval(checkHealth, 60000);
</script>
</body>
</html>
