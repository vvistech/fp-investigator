<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LEAP ‚Äî FP Exceptions Console</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Figtree:wght@300;400;500;600&display=swap');

:root {
  --bg:#f0f2f5; --surface:#fff; --surface2:#f7f8fa;
  --border:#e2e6ed; --border2:#cdd3dc;
  --ink:#111827; --ink2:#374151; --ink3:#6b7280; --ink4:#9ca3af;
  --navy:#0f1f3d; --blue:#1d4ed8; --blue-lt:#dbeafe;
  --teal:#0d9488; --teal-lt:#ccfbf1;
  --amber:#d97706; --amber-lt:#fef3c7;
  --red:#dc2626; --red-lt:#fee2e2;
  --green:#16a34a; --green-lt:#dcfce7;
  --purple:#7c3aed; --purple-lt:#ede9fe;
  --orange:#ea580c; --orange-lt:#ffedd5;
  --sidebar-w:210px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Figtree',sans-serif;background:var(--bg);color:var(--ink);font-size:13px;}
.app{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--navy);display:flex;flex-direction:column;}
.sb-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:6px;}
.sb-logo-mark{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:#fff;}
.sb-logo-mark span{color:#38bdf8;}
.sb-logo-sub{font-size:9px;color:rgba(255,255,255,0.3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sb-section{padding:0 8px;margin-bottom:4px;}
.sb-section-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.25);padding:8px 8px 4px;}
.sb-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;color:rgba(255,255,255,0.55);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;margin-bottom:1px;}
.sb-item:hover{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.85);}
.sb-item.active{background:rgba(56,189,248,0.15);color:#38bdf8;}
.sb-icon{font-size:14px;width:16px;text-align:center;}
.sb-bottom{margin-top:auto;padding:10px 8px;border-top:1px solid rgba(255,255,255,0.07);}
.sb-user{display:flex;align-items:center;gap:8px;}
.sb-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#38bdf8,#818cf8);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.sb-user-name{font-size:11px;font-weight:600;color:rgba(255,255,255,0.8);}
.sb-user-role{font-size:9px;color:rgba(255,255,255,0.3);}

/* MAIN */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 22px;height:52px;display:flex;align-items:center;gap:14px;flex-shrink:0;position:sticky;top:0;z-index:10;}
.topbar-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:8px;}
.api-status{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;}
.api-status.ok{background:var(--green-lt);color:var(--green);}
.api-status.err{background:var(--red-lt);color:var(--red);}
.api-status.checking{background:var(--amber-lt);color:var(--amber);}

/* PAGES */
.page{padding:22px;flex:1;display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Figtree',sans-serif;}
.btn-primary{background:var(--blue);color:#fff;}
.btn-primary:hover{background:#1e40af;}
.btn-primary:disabled{background:var(--border2);color:var(--ink4);cursor:not-allowed;}

/* BTF TRIGGER BUTTON */
.btn-btf{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(124,58,237,0.3);white-space:nowrap;}
.btn-btf:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);transform:translateY(-1px);}

/* SEND TO PO BUTTON */
.btn-po{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#ea580c,#c2410c);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(234,88,12,0.3);white-space:nowrap;}
.btn-po:hover{background:linear-gradient(135deg,#c2410c,#9a3412);transform:translateY(-1px);}

/* USB TRIGGER BUTTON */
.btn-usb{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#0d9488,#0f766e);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(13,148,136,0.3);white-space:nowrap;}
.btn-usb:hover{background:linear-gradient(135deg,#0f766e,#115e59);transform:translateY(-1px);}
.modal-icon-usb{background:var(--teal-lt);}
.modal-warning-usb{background:var(--teal-lt);border:1px solid #5eead4;color:#134e4a;}
.btn-confirm-usb{background:linear-gradient(135deg,#0d9488,#0f766e);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-usb:hover{background:linear-gradient(135deg,#0f766e,#115e59);}

/* SENT STATES */
.btn-sent-ok{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--green-lt);color:var(--green);border:1px solid #86efac;white-space:nowrap;}
.btn-sending{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--surface2);color:var(--ink3);border:1px solid var(--border);white-space:nowrap;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.card-header{padding:11px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.card-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;}
.card-body{padding:14px 16px;}

/* CHIPS */
.chip{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;}
.chip-teal{background:var(--teal-lt);color:var(--teal);}
.chip-gray{background:var(--surface2);color:var(--ink3);border:1px solid var(--border);}
.chip-blue{background:var(--blue-lt);color:var(--blue);}
.chip-amber{background:var(--amber-lt);color:var(--amber);}

/* COMPACT TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;table-layout:auto;}
thead th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--ink3);background:var(--surface2);border-bottom:1px solid var(--border);white-space:nowrap;}
thead th.status-col{background:#f0f7ff;color:var(--blue);border-bottom:2px solid #93c5fd;}
thead th.fp-col{background:#f0fdfb;color:var(--teal);border-bottom:2px solid #5eead4;}
thead th.action-col{background:#faf5ff;color:var(--purple);border-bottom:2px solid #c4b5fd;}
tbody td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;color:var(--ink2);vertical-align:middle;white-space:nowrap;}
tbody tr:last-child td{border-bottom:none;}
tbody tr.row-fp{background:#fafffe;}

/* STATUS CELLS */
.st{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;}
.st-ok{color:var(--green);}
.st-warn{color:var(--amber);}
.st-err{color:var(--red);}
.st-null{color:var(--ink4);font-weight:400;}
.st-processed{color:var(--green);font-weight:700;}

/* FORM */
.input{width:100%;padding:7px 11px;border-radius:7px;border:1px solid var(--border2);background:var(--surface);font-size:12px;font-family:'Figtree',sans-serif;color:var(--ink);outline:none;transition:border-color .15s,box-shadow .15s;}
.input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(29,78,216,0.1);}
.input-group{position:relative;}
.input-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none;}
.input-group .input{padding-left:30px;}
.mono{font-family:'JetBrains Mono',monospace;font-size:11px;}

/* PAGE HEADERS */
.page-head{margin-bottom:18px;}
.page-head h1{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.page-head p{color:var(--ink3);font-size:12px;}

/* SEARCH BAR */
.search-bar{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;}

/* STATES */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.spinner-dark{border-color:rgba(0,0,0,0.1);border-top-color:var(--blue);}
.state-box{text-align:center;padding:50px 20px;color:var(--ink4);}
.state-box .icon{font-size:36px;margin-bottom:10px;}
.state-box h3{font-size:13px;font-weight:600;color:var(--ink3);margin-bottom:4px;}
.state-box p{font-size:11px;}
.error-banner{background:var(--red-lt);border:1px solid #fca5a5;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--red);display:flex;align-items:flex-start;gap:8px;}

/* RESULT META */
.result-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.query-tag{font-size:10px;padding:2px 7px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;color:var(--ink3);}
.query-tag.has-results{background:var(--blue-lt);border-color:#93c5fd;color:var(--blue);}

/* HOME */
.home-hero{background:linear-gradient(135deg,var(--navy) 0%,#1e3a5f 100%);border-radius:12px;padding:30px;margin-bottom:20px;position:relative;overflow:hidden;}
.home-hero::before{content:'FP';position:absolute;right:28px;top:50%;transform:translateY(-50%);font-family:'Syne',sans-serif;font-size:120px;font-weight:800;color:rgba(255,255,255,0.04);line-height:1;pointer-events:none;}
.home-hero h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#fff;margin-bottom:6px;}
.home-hero p{color:rgba(255,255,255,0.55);font-size:12px;max-width:480px;line-height:1.6;}
.home-quick{display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-top:20px;}
.hq-card{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;}
.hq-card:hover{background:rgba(255,255,255,0.12);}
.hq-icon{font-size:20px;margin-bottom:8px;}
.hq-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;}
.hq-desc{font-size:11px;color:rgba(255,255,255,0.45);line-height:1.5;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:#fff;border-radius:14px;width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.2);transform:translateY(10px) scale(0.98);transition:transform .2s;overflow:hidden;}
.overlay.open .modal{transform:translateY(0) scale(1);}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.modal-icon-btf{background:var(--purple-lt);}
.modal-icon-po{background:var(--orange-lt);}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;margin-bottom:2px;}
.modal-sub{font-size:11px;color:var(--ink3);}
.modal-body{padding:18px 22px;}
.modal-detail{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:14px;}
.modal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.modal-row:last-child{margin-bottom:0;}
.modal-lbl{font-size:11px;color:var(--ink3);font-weight:500;}
.modal-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--ink);}
.modal-warning{border-radius:7px;padding:10px 12px;font-size:11px;display:flex;gap:8px;align-items:flex-start;}
.modal-warning-btf{background:var(--amber-lt);border:1px solid #fcd34d;color:#92400e;}
.modal-warning-po{background:var(--orange-lt);border:1px solid #fdba74;color:#9a3412;}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{background:var(--surface2);color:var(--ink2);border:1px solid var(--border2);padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Figtree',sans-serif;}
.btn-cancel:hover{background:var(--border);}
.btn-confirm-btf{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-btf:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);}
.btn-confirm-po{background:linear-gradient(135deg,#ea580c,#c2410c);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm-po:hover{background:linear-gradient(135deg,#c2410c,#9a3412);}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 18px;border-radius:10px;font-size:12px;font-weight:600;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.15);transform:translateY(10px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-ok{background:var(--green-lt);color:var(--green);border:1px solid #86efac;}
.toast-err{background:var(--red-lt);color:var(--red);border:1px solid #fca5a5;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}

/* BULK RESULTS */
.bulk-group{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:14px;}
.bulk-group-header{padding:10px 16px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;cursor:pointer;user-select:none;}
.bulk-group-header:hover{background:#eef0f5;}
.bulk-group-xid{font-family:'JetBrains Mono',monospace;font-size:12px;font-weight:700;color:var(--blue);}
.bulk-group-count{font-size:11px;font-weight:600;padding:2px 8px;border-radius:20px;}
.bulk-group-count.found{background:var(--green-lt);color:var(--green);}
.bulk-group-count.none{background:var(--surface2);color:var(--ink4);border:1px solid var(--border);}
.bulk-group-count.error{background:var(--red-lt);color:var(--red);}
.bulk-group-toggle{margin-left:auto;font-size:12px;color:var(--ink4);transition:transform .2s;}
.bulk-group.collapsed .bulk-group-toggle{transform:rotate(-90deg);}
.bulk-group.collapsed .bulk-group-body{display:none;}
.bulk-group-body{overflow-x:auto;}
.bulk-summary-bar{display:flex;align-items:center;gap:14px;padding:10px 16px;background:#f8f9fb;border-bottom:1px solid var(--border);font-size:11px;color:var(--ink3);}
.bulk-summary-bar strong{color:var(--ink);font-weight:700;}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">LEA<span>P</span></div>
    <div class="sb-logo-sub">FP Exceptions Console</div>
  </div>
  <div class="sb-section">
    <div class="sb-section-label">FP Exceptions Console</div>
    <div class="sb-item active" onclick="nav('search')" id="nav-search"><span class="sb-icon">‚åï</span> FP Shipment Review</div>
  </div>
  <div class="sb-bottom">
    <div class="sb-user">
      <div class="sb-avatar">FP</div>
      <div>
        <div class="sb-user-name">KFNA.BULK_PLAN</div>
        <div class="sb-user-role">OTM Service Account</div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">FP Shipment Review</div>
    <div class="topbar-actions">
      <div class="api-status checking" id="api-status">
        <span class="spinner spinner-dark" style="width:9px;height:9px;border-top-color:var(--amber);"></span>
        Checking OTM...
      </div>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="page active" id="page-search">
    <div class="page-head">
      <h1>Search</h1>
      <p>Enter one value or multiple comma-separated values. Results are grouped per value when searching in bulk.</p>
    </div>
    <div class="search-bar">
      <div style="display:flex;gap:8px;align-items:flex-start;">
        <div style="flex:1;">
          <textarea class="input" id="search-input" rows="2"
            style="resize:vertical;font-family:'JetBrains Mono',monospace;font-size:12px;line-height:1.7;"
            placeholder="e.g. 3563932506  or  3563932506, 3563926053, 3563889852"
            onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();doSearch();}"></textarea>
          <div style="margin-top:5px;font-size:10px;color:var(--ink4);" id="search-hint">
            Press Enter to search ¬∑ Separate multiple values with commas
          </div>
        </div>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <button class="btn btn-primary" id="search-btn" onclick="doSearch()">Search OTM</button>
          <button class="btn" style="background:var(--surface2);color:var(--ink3);border:1px solid var(--border2);font-size:11px;" onclick="clearSearch()">Clear</button>
        </div>
      </div>
    </div>

    <div id="refresh-bar" style="display:none;align-items:center;gap:10px;background:#eff6ff;border:1px solid #93c5fd;border-radius:8px;padding:9px 14px;margin-bottom:12px;font-size:12px;color:var(--blue);">
      <span>‚úÖ Action sent to OTM successfully. Dependent workflows may still be running.</span>
      <button class="btn btn-primary" style="padding:5px 14px;font-size:11px;margin-left:auto;" onclick="doSearch();hideRefreshBar();">‚Üª Refresh Results</button>
    </div>
    <div id="search-error" class="error-banner" style="display:none;"><span>‚ö†</span><div id="search-error-text"></div></div>
    <div class="state-box" id="search-empty">
      <div class="icon">‚åï</div>
      <h3>Enter a value to search</h3>
      <p>Single value or comma-separated list ‚Äî the tool handles both automatically</p>
    </div>
    <div class="state-box" id="search-loading" style="display:none;">
      <div class="spinner spinner-dark" style="width:26px;height:26px;margin:0 auto 10px;"></div>
      <h3 id="search-loading-text">Querying OTM...</h3>
      <p id="search-loading-sub">Fetching results</p>
    </div>

    <!-- SINGLE RESULT (one value) -->
    <div id="search-results" style="display:none;">
      <div class="result-meta" id="result-meta"></div>
      <div class="card" style="margin-bottom:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Shipment ID</th><th>Name</th><th>Type</th><th>Src</th><th>Mode</th><th>Carrier</th>
                <th>Origin</th><th>Dest</th><th>Start</th><th>Weight</th><th>Cost (USD)</th>
                <th class="status-col">BTF Elig</th><th class="status-col">BTF Pricing</th>
                <th class="status-col">USB Status</th>
                <th class="fp-col">FP Status</th><th class="action-col">Actions</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- BULK RESULTS (multiple values) -->
    <div id="bulk-results" style="display:none;"></div>
  </div>

</div>
</div>

<!-- MODAL (shared for both BTF and Send to PO) -->
<div class="overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon" id="modal-icon">‚ö°</div>
      <div>
        <div class="modal-title" id="modal-title">‚Äî</div>
        <div class="modal-sub" id="modal-sub">‚Äî</div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-detail">
        <div class="modal-row">
          <span class="modal-lbl">Shipment ID</span>
          <span class="modal-val" id="modal-xid">‚Äî</span>
        </div>
        <div class="modal-row">
          <span class="modal-lbl">Carrier</span>
          <span class="modal-val" id="modal-carrier">‚Äî</span>
        </div>
        <div class="modal-row" id="modal-extra-row">
          <span class="modal-lbl" id="modal-extra-lbl">‚Äî</span>
          <span class="modal-val" id="modal-extra-val">‚Äî</span>
        </div>
      </div>
      <div class="modal-warning" id="modal-warning">
        <span>‚ö†Ô∏è</span>
        <div id="modal-warning-text">‚Äî</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button id="modal-confirm-btn" onclick="confirmAction()">Confirm</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const API = '';
let pendingAction = null; // { type: 'btf'|'po'|'usb', xid, carrier }
const actionsInFlight = new Set(); // per-xid lock to prevent double-submit on same row

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function nav(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  const ni = document.getElementById('nav-' + page);
  if (ni) ni.classList.add('active');
  document.getElementById('topbar-title').textContent = {search:'FP Shipment Review'}[page] || page;
}

// ‚îÄ‚îÄ UNIFIED SEARCH ‚îÄ‚îÄ
function clearSearch() {
  document.getElementById('search-input').value = '';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('bulk-results').style.display = 'none';
  document.getElementById('bulk-results').innerHTML = '';
  document.getElementById('search-empty').style.display = 'block';
  document.getElementById('search-error').style.display = 'none';
}

async function doSearch() {
  const raw = document.getElementById('search-input').value.trim();
  if (!raw) { alert('Please enter a search value.'); return; }

  const vals = [...new Set(raw.split(',').map(v => v.trim()).filter(Boolean))];
  const isBulk = vals.length > 1;

  // Reset state
  hideRefreshBar();
  document.getElementById('search-empty').style.display = 'none';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('bulk-results').style.display = 'none';
  document.getElementById('bulk-results').innerHTML = '';
  document.getElementById('search-error').style.display = 'none';
  document.getElementById('search-loading').style.display = 'block';
  document.getElementById('search-loading-text').textContent = isBulk
    ? `Querying OTM for ${vals.length} values...`
    : 'Querying OTM...';
  document.getElementById('search-loading-sub').textContent = isBulk
    ? 'Results will be grouped per value'
    : 'Fetching results';

  const btn = document.getElementById('search-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Searching...';

  try {
    if (isBulk) {
      if (vals.length > 100) throw new Error('Maximum 100 values per request.');
      const resp = await fetch(`${API}/api/bulk-search`, {
        method: 'POST',
        headers: { 'Content-Type': 'text/plain' },
        body: vals.join(',')
      });
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);
      renderBulkResults(data);
    } else {
      const resp = await fetch(`${API}/api/search?q=${encodeURIComponent(vals[0])}`);
      const data = await resp.json();
      if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);
      renderResults(data);
    }
  } catch (err) {
    document.getElementById('search-error-text').textContent = `Error: ${err.message}`;
    document.getElementById('search-error').style.display = 'flex';
  } finally {
    document.getElementById('search-loading').style.display = 'none';
    btn.disabled = false;
    btn.innerHTML = 'Search OTM';
  }
}

// ‚îÄ‚îÄ CELL HELPERS ‚îÄ‚îÄ
function stCell(value) {
  if (!value) return `<td><span class="st st-null">‚Äî</span></td>`;
  const v = value.toUpperCase();
  let cls = 'st-null';
  if (['Y','PRICED','PROCESSED','SENT'].includes(v)) cls = 'st-ok';
  else if (['N','NOT_PROCESSED','REPROCESS'].includes(v)) cls = 'st-warn';
  else if (['ERROR','HOLD'].includes(v)) cls = 'st-err';
  return `<td><span class="st ${cls}">${value}</span></td>`;
}

function fpStatusCell(isFP, attr10) {
  if (!isFP) return `<td><span class="st st-null">‚Äî</span></td>`;
  const isEmpty = attr10 === null || attr10 === undefined || attr10 === '';
  return isEmpty
    ? `<td><span class="st st-null">‚Äî</span></td>`
    : `<td><span class="st st-err" title="${attr10}">${attr10}</span></td>`;
}

// ‚îÄ‚îÄ ACTION CELL ‚îÄ‚îÄ
function actionCell(s) {
  const isFP    = s.shipmentAsWork;
  const isTL    = (s.transportMode || '').toUpperCase() === 'TL';
  const st      = s.statuses || {};
  const xid     = s.shipmentXid;
  const carrier = (s.carrier || '‚Äî').replace(/'/g, "\\'");
  const attr10  = s.attribute10;
  const fpBlocked = attr10 !== null && attr10 !== undefined && attr10 !== '';

  if (isFP) {
    const btfElig   = (st.BTF_SHIP_IND?.value       || '').toUpperCase();
    const btfPrice  = (st.BTF_RATE_IND?.value        || '').toUpperCase();
    const usbStatus = (st.SEND_SHIPMENT_USB?.value   || '').toUpperCase();

    // BTF Trigger ‚Äî TL + BTF Elig Y + NOT_PROCESSED or REPROCESS
    if (isTL && btfElig === 'Y' && (btfPrice === 'NOT_PROCESSED' || btfPrice === 'REPROCESS')) {
      return `<td><button class="btn-btf" id="action-btn-${xid}" onclick="openModal('btf','${xid}','${carrier}',this)">‚ö° Trigger BTF</button></td>`;
    }
    // USB Trigger ‚Äî BTF REPROCESS + SEND_SHIPMENT_USB = N + FP Status blank
    if (btfPrice === 'REPROCESS' && usbStatus === 'N' && !fpBlocked) {
      return `<td><button class="btn-usb" id="action-btn-${xid}" onclick="openModal('usb','${xid}','${carrier}',this)">üì° Trigger USB</button></td>`;
    }
    if (btfPrice === 'PRICED') {
      return `<td><span class="st st-ok" style="font-size:10px;">‚úì Priced</span></td>`;
    }
    if (btfPrice === 'ERROR') {
      return `<td><span class="st st-err" style="font-size:10px;">‚ö† Error</span></td>`;
    }
    if (btfPrice === 'HOLD') {
      return `<td><span class="st st-warn" style="font-size:10px;">‚è∏ Hold</span></td>`;
    }
    return `<td><span class="st st-null">‚Äî</span></td>`;
  } else {
    // Send to PO ‚Äî TOC only, attributeNumber1 is null or 2
    const attrNum1 = s.attributeNumber1;
    const eligible = attrNum1 === null || attrNum1 === undefined || attrNum1 === '' || String(attrNum1) === '2';
    if (eligible) {
      return `<td><button class="btn-po" id="action-btn-${xid}" onclick="openModal('po','${xid}','${carrier}',this)">üì§ Send to PO</button></td>`;
    }
    return `<td><span class="st st-null">‚Äî</span></td>`;
  }
}

function renderResults(data) {
  document.getElementById('search-results').style.display = 'block';
  const meta = document.getElementById('result-meta');
  let mh = `<span style="font-size:12px;font-weight:600;color:var(--ink3);">${data.totalCount} shipment${data.totalCount!==1?'s':''} found</span>`;
  mh += ` <span style="font-size:11px;color:var(--ink4);">¬∑ Live from OTM</span>`;
  meta.innerHTML = mh;

  const tbody = document.getElementById('results-body');
  if (!data.items || data.items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="16" style="text-align:center;padding:28px;color:var(--ink4);">No shipments found.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.items.map(s => {
    const isFP = s.shipmentAsWork;
    const startDate = s.startTime ? s.startTime.split('T')[0] : '‚Äî';
    const weight = s.totalWeight != null ? `${Number(s.totalWeight).toLocaleString()} ${s.weightUnit||''}` : '‚Äî';
    const cost = s.totalActualCost != null
      ? `$${Number(s.totalActualCost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}` : '‚Äî';
    const typeChip = isFP ? `<span class="chip chip-teal">FP</span>` : `<span class="chip chip-gray">TOC</span>`;
    const rowCls = isFP ? 'row-fp' : '';
    const st = s.statuses || {};

    let srcChip = `<span class="st st-null">‚Äî</span>`;
    if (s.dataSource) {
      const dc = s.dataSource.toUpperCase().includes('SAP') ? 'chip-amber' : 'chip-blue';
      srcChip = `<span class="chip ${dc}">${s.dataSource}</span>`;
    }

    const btfElig  = isFP ? stCell(st.BTF_SHIP_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
    const btfPrice = isFP ? stCell(st.BTF_RATE_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
    const usbSt    = isFP ? stCell(st.SENT_TO_USB?.value) : `<td><span class="st st-null">‚Äî</span></td>`;
    const fpSt     = fpStatusCell(isFP, s.attribute10);
    const action   = actionCell(s);

    return `
      <tr class="${rowCls}">
        <td class="mono" style="color:var(--blue);font-weight:600;font-size:11px;">${s.shipmentXid||'‚Äî'}</td>
        <td class="mono">${s.shipmentName||'‚Äî'}</td>
        <td>${typeChip}</td>
        <td>${srcChip}</td>
        <td><span class="chip chip-gray">${s.transportMode||'‚Äî'}</span></td>
        <td style="font-weight:500;">${s.carrier||'‚Äî'}</td>
        <td class="mono" style="font-size:10px;">${s.sourceLocation||'‚Äî'}</td>
        <td class="mono" style="font-size:10px;">${s.destLocation||'‚Äî'}</td>
        <td style="color:var(--ink3);">${startDate}</td>
        <td>${weight}</td>
        <td style="font-weight:600;">${cost}</td>
        ${btfElig}${btfPrice}${usbSt}${fpSt}${action}
      </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(type, xid, carrier, btnEl) {
  pendingAction = { type, xid, carrier, btnEl: btnEl || null };

  document.getElementById('modal-xid').textContent     = xid;
  document.getElementById('modal-carrier').textContent = carrier;

  if (type === 'btf') {
    document.getElementById('modal-icon').className      = 'modal-icon modal-icon-btf';
    document.getElementById('modal-icon').textContent    = '‚ö°';
    document.getElementById('modal-title').textContent   = 'Trigger BTF Pricing';
    document.getElementById('modal-sub').textContent     = 'Send BTF reprocess request to OTM WMServlet';
    document.getElementById('modal-extra-lbl').textContent = 'Current BTF Pricing';
    document.getElementById('modal-extra-val').textContent = 'NOT_PROCESSED';
    document.getElementById('modal-extra-val').style.color = 'var(--amber)';
    document.getElementById('modal-warning').className   = 'modal-warning modal-warning-btf';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger BTF fuel cost calculation. BTF_RATE_IND will be set to REPROCESS.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className   = 'btn-confirm-btf';
    btn.textContent = '‚ö° Confirm & Send';
  } else if (type === 'usb') {
    document.getElementById('modal-icon').className      = 'modal-icon modal-icon-usb';
    document.getElementById('modal-icon').textContent    = 'üì°';
    document.getElementById('modal-title').textContent   = 'Trigger USB';
    document.getElementById('modal-sub').textContent     = 'Send SEND_SHIPMENT_USB - R to OTM WMServlet';
    document.getElementById('modal-extra-lbl').textContent = 'Status Value';
    document.getElementById('modal-extra-val').textContent = 'SEND_SHIPMENT_USB - R';
    document.getElementById('modal-extra-val').style.color = 'var(--teal)';
    document.getElementById('modal-warning').className   = 'modal-warning modal-warning-usb';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger USB transmission. SEND_SHIPMENT_USB will be set to R.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className   = 'btn-confirm-usb';
    btn.textContent = 'üì° Confirm & Send';
  } else {
    document.getElementById('modal-icon').className      = 'modal-icon modal-icon-po';
    document.getElementById('modal-icon').textContent    = 'üì§';
    document.getElementById('modal-title').textContent   = 'Send to PO';
    document.getElementById('modal-sub').textContent     = 'Trigger FP shipment creation via OTM PO workflow';
    document.getElementById('modal-extra-lbl').textContent = 'Action';
    document.getElementById('modal-extra-val').textContent = 'SEND_SHIPMENT_PO - R';
    document.getElementById('modal-extra-val').style.color = 'var(--orange)';
    document.getElementById('modal-warning').className   = 'modal-warning modal-warning-po';
    document.getElementById('modal-warning-text').textContent = 'This will POST an XML message to OTM to trigger the Send to PO workflow. An FP shipment will be created with Data Source = OTM.';
    const btn = document.getElementById('modal-confirm-btn');
    btn.className   = 'btn-confirm-po';
    btn.textContent = 'üì§ Confirm & Send';
  }

  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  pendingAction = null;
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

async function confirmAction() {
  if (!pendingAction) return;
  const { type, xid } = pendingAction;
  if (actionsInFlight.has(xid)) return;
  actionsInFlight.add(xid);
  const confirmBtn = document.getElementById('modal-confirm-btn');
  confirmBtn.disabled = true;
  confirmBtn.style.pointerEvents = 'none';
  confirmBtn.innerHTML = '<span class="spinner"></span> Sending...';

  // Update row button to sending state ‚Äî use stored element ref, not getElementById (avoids dupe ID issue in bulk)
  const rowBtn = pendingAction.btnEl;
  if (rowBtn) rowBtn.outerHTML = `<span class="btn-sending" id="action-btn-${xid}"><span class="spinner spinner-dark" style="width:10px;height:10px;border-top-color:var(--ink3);"></span> Sending...</span>`;

  const endpoint = type === 'btf'
    ? `${API}/api/trigger-btf/${encodeURIComponent(xid)}`
    : type === 'usb'
    ? `${API}/api/trigger-usb/${encodeURIComponent(xid)}`
    : `${API}/api/send-to-po/${encodeURIComponent(xid)}`;

  try {
    const resp = await fetch(endpoint, { method: 'POST' });
    const data = await resp.json();
    closeModal(); // also resets actionInFlight

    const btn = document.getElementById(`action-btn-${xid}`);
    const btnClass = type === 'btf' ? 'btn-btf' : type === 'usb' ? 'btn-usb' : 'btn-po';
    const btnLabel = type === 'btf' ? '‚ö° Retry' : type === 'usb' ? 'üì° Retry' : 'üì§ Retry';

    if (data.status === 'ok') {
      const label = type === 'btf' ? 'BTF trigger' : type === 'usb' ? 'USB trigger' : 'Send to PO';
      // Clear the spinning row button to ‚úÖ Sent
      if (btn) btn.outerHTML = `<span class="btn-sent-ok">‚úÖ Sent</span>`;
      showToast(`‚úÖ ${label} sent for ${xid}`, 'ok');
      showRefreshBar();
    } else {
      // Restore button to retry state
      if (btn) btn.outerHTML = `<button class="${btnClass}" id="action-btn-${xid}" onclick="openModal('${type}','${xid}','',this)">${btnLabel}</button>`;
      showToast(`‚ùå OTM returned HTTP ${data.httpStatus}`, 'err');
    }
  } catch (err) {
    closeModal(); // also resets actionInFlight
    const btn = document.getElementById(`action-btn-${xid}`);
    const btnClass = type === 'btf' ? 'btn-btf' : type === 'usb' ? 'btn-usb' : 'btn-po';
    const btnLabel = type === 'btf' ? '‚ö° Retry' : type === 'usb' ? 'üì° Retry' : 'üì§ Retry';
    if (btn) btn.outerHTML = `<button class="${btnClass}" id="action-btn-${xid}" onclick="openModal('${type}','${xid}','',this)">${btnLabel}</button>`;
    showToast(`‚ùå Error: ${err.message}`, 'err');
  } finally {
    actionsInFlight.delete(xid);
  }
}

// ‚îÄ‚îÄ REFRESH BAR ‚îÄ‚îÄ
function showRefreshBar() {
  const bar = document.getElementById('refresh-bar');
  if (bar) bar.style.display = 'flex';
}

function hideRefreshBar() {
  const bar = document.getElementById('refresh-bar');
  if (bar) bar.style.display = 'none';
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

// ‚îÄ‚îÄ BULK RENDER ‚îÄ‚îÄ
function renderBulkResults(data) {
  const container = document.getElementById('bulk-results');
  container.style.display = 'block';

  // Summary bar
  const found = data.results.filter(r => r.totalCount > 0).length;
  const notFound = data.results.filter(r => r.totalCount === 0).length;
  const errors = data.results.filter(r => r.errors && r.errors.length > 0).length;
  let html = `
    <div class="bulk-summary-bar">
      <span>üîç <strong>${data.totalValues}</strong> values searched</span>
      <span>üì¶ <strong>${data.totalShipments}</strong> total shipments found</span>
      <span style="color:var(--green);">‚úì <strong>${found}</strong> with results</span>
      ${notFound ? `<span style="color:var(--ink4);">‚óã <strong>${notFound}</strong> no results</span>` : ''}
      ${errors  ? `<span style="color:var(--red);">‚ö† <strong>${errors}</strong> errors</span>` : ''}
    </div>`;

  // One group per search value
  data.results.forEach((group, idx) => {
    const hasResults = group.totalCount > 0;
    const hasError   = group.errors && group.errors.length > 0;
    const countCls   = hasError ? 'error' : hasResults ? 'found' : 'none';
    const countLbl   = hasError ? '‚ö† Error' : hasResults ? `${group.totalCount} found` : 'No results';

    // Query tags ‚Äî intentionally omitted (internal implementation detail)
    const queryTags = '';

    // Rows
    let rowsHtml = '';
    if (!hasResults) {
      rowsHtml = `<tr><td colspan="16" style="text-align:center;padding:20px;color:var(--ink4);font-size:12px;">
        ${hasError ? `‚ö† ${group.errors[0]}` : 'No shipments found for this value.'}</td></tr>`;
    } else {
      rowsHtml = group.items.map(s => {
        const isFP = s.shipmentAsWork;
        const startDate = s.startTime ? s.startTime.split('T')[0] : '‚Äî';
        const weight = s.totalWeight != null ? `${Number(s.totalWeight).toLocaleString()} ${s.weightUnit||''}` : '‚Äî';
        const cost = s.totalActualCost != null
          ? `$${Number(s.totalActualCost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}` : '‚Äî';
        const typeChip = isFP ? `<span class="chip chip-teal">FP</span>` : `<span class="chip chip-gray">TOC</span>`;
        const rowCls = isFP ? 'row-fp' : '';
        const st = s.statuses || {};
        let srcChip = `<span class="st st-null">‚Äî</span>`;
        if (s.dataSource) {
          const dc = s.dataSource.toUpperCase().includes('SAP') ? 'chip-amber' : 'chip-blue';
          srcChip = `<span class="chip ${dc}">${s.dataSource}</span>`;
        }
        const btfElig  = isFP ? stCell(st.BTF_SHIP_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
        const btfPrice = isFP ? stCell(st.BTF_RATE_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
        const usbSt    = isFP ? stCell(st.SENT_TO_USB?.value) : `<td><span class="st st-null">‚Äî</span></td>`;
        const fpSt     = fpStatusCell(isFP, s.attribute10);
        const action   = actionCell(s);
        return `<tr class="${rowCls}">
          <td class="mono" style="color:var(--blue);font-weight:600;font-size:11px;">${s.shipmentXid||'‚Äî'}</td>
          <td class="mono">${s.shipmentName||'‚Äî'}</td>
          <td>${typeChip}</td>
          <td>${srcChip}</td>
          <td><span class="chip chip-gray">${s.transportMode||'‚Äî'}</span></td>
          <td style="font-weight:500;">${s.carrier||'‚Äî'}</td>
          <td class="mono" style="font-size:10px;">${s.sourceLocation||'‚Äî'}</td>
          <td class="mono" style="font-size:10px;">${s.destLocation||'‚Äî'}</td>
          <td style="color:var(--ink3);">${startDate}</td>
          <td>${weight}</td>
          <td style="font-weight:600;">${cost}</td>
          ${btfElig}${btfPrice}${usbSt}${fpSt}${action}
        </tr>`;
      }).join('');
    }

    html += `
      <div class="bulk-group" id="bulk-group-${idx}">
        <div class="bulk-group-header" onclick="toggleBulkGroup(${idx})">
          <span class="bulk-group-xid">${group.searchValue}</span>
          <span class="bulk-group-count ${countCls}">${countLbl}</span>
          <span class="bulk-group-toggle">‚ñº</span>
        </div>
        <div class="bulk-group-body">
          <div class="table-wrap">
            <table>
              <thead><tr>
                <th>Shipment ID</th><th>Name</th><th>Type</th><th>Src</th><th>Mode</th><th>Carrier</th>
                <th>Origin</th><th>Dest</th><th>Start</th><th>Weight</th><th>Cost (USD)</th>
                <th class="status-col">BTF Elig</th><th class="status-col">BTF Pricing</th>
                <th class="status-col">USB Status</th>
                <th class="fp-col">FP Status</th><th class="action-col">Actions</th>
              </tr></thead>
              <tbody>${rowsHtml}</tbody>
            </table>
          </div>
        </div>
      </div>`;
  });

  container.innerHTML = html;
}

function toggleBulkGroup(idx) {
  document.getElementById(`bulk-group-${idx}`).classList.toggle('collapsed');
}

// ‚îÄ‚îÄ HEALTH CHECK ‚îÄ‚îÄ
async function checkHealth() {
  const el = document.getElementById('api-status');
  try {
    const resp = await fetch('/api/health', {signal: AbortSignal.timeout(8000)});
    const data = await resp.json();
    el.className = data.status === 'ok' ? 'api-status ok' : 'api-status err';
    el.innerHTML = data.status === 'ok' ? '‚óè OTM Connected' : '‚óè OTM Error';
  } catch {
    el.className = 'api-status err';
    el.innerHTML = '‚óè OTM Unreachable';
  }
}
checkHealth();
setInterval(checkHealth, 60000);
</script>
</body>
</html>
