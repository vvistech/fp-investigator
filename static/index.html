<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FreightPay Investigator</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=JetBrains+Mono:wght@400;500;600&family=Figtree:wght@300;400;500;600&display=swap');

:root {
  --bg:#f0f2f5; --surface:#fff; --surface2:#f7f8fa;
  --border:#e2e6ed; --border2:#cdd3dc;
  --ink:#111827; --ink2:#374151; --ink3:#6b7280; --ink4:#9ca3af;
  --navy:#0f1f3d; --blue:#1d4ed8; --blue-lt:#dbeafe;
  --teal:#0d9488; --teal-lt:#ccfbf1;
  --amber:#d97706; --amber-lt:#fef3c7;
  --red:#dc2626; --red-lt:#fee2e2;
  --green:#16a34a; --green-lt:#dcfce7;
  --purple:#7c3aed; --purple-lt:#ede9fe;
  --sidebar-w:210px;
}
*{box-sizing:border-box;margin:0;padding:0;}
html,body{height:100%;font-family:'Figtree',sans-serif;background:var(--bg);color:var(--ink);font-size:13px;}
.app{display:flex;height:100vh;overflow:hidden;}

/* SIDEBAR */
.sidebar{width:var(--sidebar-w);flex-shrink:0;background:var(--navy);display:flex;flex-direction:column;}
.sb-logo{padding:18px 18px 14px;border-bottom:1px solid rgba(255,255,255,0.07);margin-bottom:6px;}
.sb-logo-mark{font-family:'Syne',sans-serif;font-size:16px;font-weight:800;color:#fff;}
.sb-logo-mark span{color:#38bdf8;}
.sb-logo-sub{font-size:9px;color:rgba(255,255,255,0.3);letter-spacing:2px;text-transform:uppercase;margin-top:2px;}
.sb-section{padding:0 8px;margin-bottom:4px;}
.sb-section-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.25);padding:8px 8px 4px;}
.sb-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:7px;color:rgba(255,255,255,0.55);font-size:12px;font-weight:500;cursor:pointer;transition:all .15s;margin-bottom:1px;}
.sb-item:hover{background:rgba(255,255,255,0.07);color:rgba(255,255,255,0.85);}
.sb-item.active{background:rgba(56,189,248,0.15);color:#38bdf8;}
.sb-icon{font-size:14px;width:16px;text-align:center;}
.sb-bottom{margin-top:auto;padding:10px 8px;border-top:1px solid rgba(255,255,255,0.07);}
.sb-user{display:flex;align-items:center;gap:8px;}
.sb-avatar{width:28px;height:28px;border-radius:50%;background:linear-gradient(135deg,#38bdf8,#818cf8);display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:700;color:#fff;flex-shrink:0;}
.sb-user-name{font-size:11px;font-weight:600;color:rgba(255,255,255,0.8);}
.sb-user-role{font-size:9px;color:rgba(255,255,255,0.3);}

/* MAIN */
.main{flex:1;overflow-y:auto;display:flex;flex-direction:column;min-width:0;}
.topbar{background:var(--surface);border-bottom:1px solid var(--border);padding:0 22px;height:52px;display:flex;align-items:center;gap:14px;flex-shrink:0;position:sticky;top:0;z-index:10;}
.topbar-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:700;}
.topbar-actions{margin-left:auto;display:flex;align-items:center;gap:8px;}
.api-status{display:flex;align-items:center;gap:5px;font-size:11px;font-weight:600;padding:3px 9px;border-radius:20px;}
.api-status.ok{background:var(--green-lt);color:var(--green);}
.api-status.err{background:var(--red-lt);color:var(--red);}
.api-status.checking{background:var(--amber-lt);color:var(--amber);}

/* PAGES */
.page{padding:22px;flex:1;display:none;}
.page.active{display:block;animation:fadeIn .2s ease;}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px);}to{opacity:1;transform:translateY(0);}}

/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:6px;padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;border:none;transition:all .15s;font-family:'Figtree',sans-serif;text-decoration:none;}
.btn-primary{background:var(--blue);color:#fff;}
.btn-primary:hover{background:#1e40af;}
.btn-primary:disabled{background:var(--border2);color:var(--ink4);cursor:not-allowed;}

/* BTF TRIGGER BUTTON */
.btn-btf{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;transition:all .15s;box-shadow:0 1px 4px rgba(124,58,237,0.3);white-space:nowrap;}
.btn-btf:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);box-shadow:0 2px 8px rgba(124,58,237,0.4);transform:translateY(-1px);}
.btn-btf:disabled{background:var(--surface2);color:var(--ink4);border:1px solid var(--border);box-shadow:none;transform:none;cursor:not-allowed;}
.btn-btf-sent{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--green-lt);color:var(--green);border:1px solid #86efac;white-space:nowrap;}
.btn-btf-sending{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:700;background:var(--purple-lt);color:var(--purple);border:1px solid #c4b5fd;white-space:nowrap;}

/* CARDS */
.card{background:var(--surface);border:1px solid var(--border);border-radius:10px;overflow:hidden;margin-bottom:12px;}
.card-header{padding:11px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;}
.card-title{font-family:'Syne',sans-serif;font-size:12px;font-weight:700;}
.card-body{padding:14px 16px;}

/* CHIPS */
.chip{display:inline-flex;align-items:center;padding:2px 7px;border-radius:20px;font-size:10px;font-weight:700;white-space:nowrap;}
.chip-teal{background:var(--teal-lt);color:var(--teal);}
.chip-gray{background:var(--surface2);color:var(--ink3);border:1px solid var(--border);}
.chip-blue{background:var(--blue-lt);color:var(--blue);}
.chip-amber{background:var(--amber-lt);color:var(--amber);}

/* COMPACT TABLE */
.table-wrap{overflow-x:auto;}
table{width:100%;border-collapse:collapse;table-layout:auto;}
thead th{padding:8px 10px;text-align:left;font-size:10px;font-weight:700;letter-spacing:.5px;text-transform:uppercase;color:var(--ink3);background:var(--surface2);border-bottom:1px solid var(--border);white-space:nowrap;}
thead th.status-col{background:#f0f7ff;color:var(--blue);border-bottom:2px solid #93c5fd;}
thead th.fp-col{background:#f0fdfb;color:var(--teal);border-bottom:2px solid #5eead4;}
thead th.action-col{background:#faf5ff;color:var(--purple);border-bottom:2px solid #c4b5fd;}
tbody td{padding:8px 10px;border-bottom:1px solid var(--border);font-size:11px;color:var(--ink2);vertical-align:middle;white-space:nowrap;}
tbody tr:last-child td{border-bottom:none;}
tbody tr.row-fp{background:#fafffe;}

/* STATUS CELLS */
.st{font-family:'JetBrains Mono',monospace;font-size:10px;font-weight:600;}
.st-ok{color:var(--green);}
.st-warn{color:var(--amber);}
.st-err{color:var(--red);}
.st-null{color:var(--ink4);font-weight:400;}
.st-processed{color:var(--green);font-weight:700;}

/* FORM */
.input{width:100%;padding:7px 11px;border-radius:7px;border:1px solid var(--border2);background:var(--surface);font-size:12px;font-family:'Figtree',sans-serif;color:var(--ink);outline:none;transition:border-color .15s,box-shadow .15s;}
.input:focus{border-color:var(--blue);box-shadow:0 0 0 3px rgba(29,78,216,0.1);}
.input-group{position:relative;}
.input-icon{position:absolute;left:10px;top:50%;transform:translateY(-50%);color:var(--ink4);pointer-events:none;font-size:13px;}
.input-group .input{padding-left:30px;}
.mono{font-family:'JetBrains Mono',monospace;font-size:11px;}

/* PAGE HEADERS */
.page-head{margin-bottom:18px;}
.page-head h1{font-family:'Syne',sans-serif;font-size:20px;font-weight:800;margin-bottom:3px;}
.page-head p{color:var(--ink3);font-size:12px;}

/* SEARCH BAR */
.search-bar{background:var(--surface);border:1px solid var(--border);border-radius:10px;padding:16px;margin-bottom:16px;}

/* STATES */
.spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
.spinner-dark{border-color:rgba(0,0,0,0.1);border-top-color:var(--blue);}
.spinner-purple{border-color:rgba(124,58,237,0.2);border-top-color:var(--purple);}
.state-box{text-align:center;padding:50px 20px;color:var(--ink4);}
.state-box .icon{font-size:36px;margin-bottom:10px;}
.state-box h3{font-size:13px;font-weight:600;color:var(--ink3);margin-bottom:4px;}
.state-box p{font-size:11px;}
.error-banner{background:var(--red-lt);border:1px solid #fca5a5;border-radius:8px;padding:10px 14px;margin-bottom:14px;font-size:12px;color:var(--red);display:flex;align-items:flex-start;gap:8px;}

/* RESULT META */
.result-meta{display:flex;align-items:center;gap:8px;margin-bottom:10px;flex-wrap:wrap;}
.query-tag{font-size:10px;padding:2px 7px;border-radius:4px;background:var(--surface2);border:1px solid var(--border);font-family:'JetBrains Mono',monospace;color:var(--ink3);}
.query-tag.has-results{background:var(--blue-lt);border-color:#93c5fd;color:var(--blue);}

/* HOME */
.home-hero{background:linear-gradient(135deg,var(--navy) 0%,#1e3a5f 100%);border-radius:12px;padding:30px;margin-bottom:20px;position:relative;overflow:hidden;}
.home-hero::before{content:'FP';position:absolute;right:28px;top:50%;transform:translateY(-50%);font-family:'Syne',sans-serif;font-size:120px;font-weight:800;color:rgba(255,255,255,0.04);line-height:1;pointer-events:none;}
.home-hero h2{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:#fff;margin-bottom:6px;}
.home-hero p{color:rgba(255,255,255,0.55);font-size:12px;max-width:480px;line-height:1.6;}
.home-quick{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:20px;}
.hq-card{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:16px;cursor:pointer;transition:all .2s;}
.hq-card:hover{background:rgba(255,255,255,0.12);}
.hq-icon{font-size:20px;margin-bottom:8px;}
.hq-title{font-family:'Syne',sans-serif;font-size:13px;font-weight:700;color:#fff;margin-bottom:3px;}
.hq-desc{font-size:11px;color:rgba(255,255,255,0.45);line-height:1.5;}

/* MODAL */
.overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);backdrop-filter:blur(3px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .2s;}
.overlay.open{opacity:1;pointer-events:all;}
.modal{background:#fff;border-radius:14px;width:440px;box-shadow:0 20px 60px rgba(0,0,0,0.2);transform:translateY(10px) scale(0.98);transition:transform .2s;overflow:hidden;}
.overlay.open .modal{transform:translateY(0) scale(1);}
.modal-header{padding:18px 22px 14px;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;gap:12px;}
.modal-icon{width:38px;height:38px;border-radius:10px;background:var(--purple-lt);display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;}
.modal-title{font-family:'Syne',sans-serif;font-size:15px;font-weight:800;margin-bottom:2px;}
.modal-sub{font-size:11px;color:var(--ink3);}
.modal-body{padding:18px 22px;}
.modal-detail{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:12px 14px;margin-bottom:14px;}
.modal-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:7px;}
.modal-row:last-child{margin-bottom:0;}
.modal-lbl{font-size:11px;color:var(--ink3);font-weight:500;}
.modal-val{font-family:'JetBrains Mono',monospace;font-size:11px;font-weight:600;color:var(--ink);}
.modal-warning{background:var(--amber-lt);border:1px solid #fcd34d;border-radius:7px;padding:10px 12px;font-size:11px;color:#92400e;display:flex;gap:8px;align-items:flex-start;}
.modal-footer{padding:14px 22px;border-top:1px solid var(--border);display:flex;gap:8px;justify-content:flex-end;}
.btn-cancel{background:var(--surface2);color:var(--ink2);border:1px solid var(--border2);padding:7px 14px;border-radius:7px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Figtree',sans-serif;}
.btn-cancel:hover{background:var(--border);}
.btn-confirm{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;padding:7px 16px;border-radius:7px;font-size:12px;font-weight:700;cursor:pointer;border:none;font-family:'Figtree',sans-serif;display:flex;align-items:center;gap:6px;}
.btn-confirm:hover{background:linear-gradient(135deg,#6d28d9,#5b21b6);}
.btn-confirm:disabled{background:var(--border2);cursor:not-allowed;}

/* TOAST */
.toast{position:fixed;bottom:24px;right:24px;padding:12px 18px;border-radius:10px;font-size:12px;font-weight:600;z-index:200;box-shadow:0 4px 20px rgba(0,0,0,0.15);transform:translateY(10px);opacity:0;transition:all .3s;pointer-events:none;}
.toast.show{transform:translateY(0);opacity:1;}
.toast-ok{background:var(--green-lt);color:var(--green);border:1px solid #86efac;}
.toast-err{background:var(--red-lt);color:var(--red);border:1px solid #fca5a5;}

::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
</style>
</head>
<body>
<div class="app">

<!-- SIDEBAR -->
<nav class="sidebar">
  <div class="sb-logo">
    <div class="sb-logo-mark">Freight<span>Pay</span></div>
    <div class="sb-logo-sub">Investigator</div>
  </div>
  <div class="sb-section">
    <div class="sb-section-label">Investigate</div>
    <div class="sb-item active" onclick="nav('home')" id="nav-home"><span class="sb-icon">‚åÇ</span> Home</div>
    <div class="sb-item" onclick="nav('search')" id="nav-search"><span class="sb-icon">‚åï</span> Search</div>
  </div>
  <div class="sb-bottom">
    <div class="sb-user">
      <div class="sb-avatar">FP</div>
      <div>
        <div class="sb-user-name">KFNA.BULK_PLAN</div>
        <div class="sb-user-role">OTM Service Account</div>
      </div>
    </div>
  </div>
</nav>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-title" id="topbar-title">Home</div>
    <div class="topbar-actions">
      <div class="api-status checking" id="api-status">
        <span class="spinner spinner-dark" style="width:9px;height:9px;border-top-color:var(--amber);"></span>
        Checking OTM...
      </div>
    </div>
  </div>

  <!-- HOME -->
  <div class="page active" id="page-home">
    <div class="home-hero">
      <h2>FreightPay Investigator</h2>
      <p>Search OTM live. View BTF, USB and FP statuses inline. Trigger BTF pricing directly from the results.</p>
      <div class="home-quick">
        <div class="hq-card" onclick="nav('search')">
          <div class="hq-icon">üîç</div>
          <div class="hq-title">Search Shipments</div>
          <div class="hq-desc">Search by shipment name, XID, order number or SAP reference. All 6 queries run in parallel.</div>
        </div>
        <div class="hq-card" onclick="nav('search')">
          <div class="hq-icon">‚ö°</div>
          <div class="hq-title">Trigger BTF</div>
          <div class="hq-desc">For eligible TL + FP shipments with BTF_SHIP_IND = Y and NOT_PROCESSED, trigger pricing directly.</div>
        </div>
      </div>
    </div>
    <div class="card">
      <div class="card-header"><span>‚Ñπ</span><span class="card-title">Column Guide</span></div>
      <div class="card-body" style="font-size:12px;color:var(--ink3);line-height:1.85;">
        <p>Status and FP columns shown only for FP shipments. TOC rows show ‚Äî.</p>
        <p style="margin-top:6px;"><strong style="color:var(--ink);">BTF Eligibility</strong> ‚Äî BTF_SHIP_IND (Y / N)</p>
        <p style="margin-top:4px;"><strong style="color:var(--ink);">BTF Pricing</strong> ‚Äî BTF_RATE_IND (NOT_PROCESSED / PRICED / HOLD / ERROR)</p>
        <p style="margin-top:4px;"><strong style="color:var(--ink);">USB Eligibility</strong> ‚Äî SEND_SHIPMENT_USB (Y / N)</p>
        <p style="margin-top:4px;"><strong style="color:var(--ink);">USB Status</strong> ‚Äî SENT_TO_USB (NOT_PROCESSED / SENT / PROCESSED)</p>
        <p style="margin-top:4px;"><strong style="color:var(--ink);">FP Status</strong> ‚Äî Attribute10. If null ‚Üí <strong style="color:var(--green);">Processed</strong></p>
        <p style="margin-top:4px;"><strong style="color:var(--purple);">‚ö° Trigger BTF</strong> ‚Äî Appears only when: FP + TL + BTF Elig = Y + BTF Pricing = NOT_PROCESSED</p>
      </div>
    </div>
  </div>

  <!-- SEARCH -->
  <div class="page" id="page-search">
    <div class="page-head">
      <h1>Search</h1>
      <p>Search by shipment name, XID, order number or SAP reference. All 6 queries run in parallel.</p>
    </div>
    <div class="search-bar">
      <div style="display:flex;gap:8px;align-items:center;">
        <div style="flex:1;">
          <div class="input-group">
            <span class="input-icon">‚åï</span>
            <input class="input" id="search-input" placeholder="e.g. 2100416780 or 920347449"
              onkeydown="if(event.key==='Enter')doSearch()">
          </div>
        </div>
        <button class="btn btn-primary" id="search-btn" onclick="doSearch()">Search OTM</button>
      </div>
      <div style="margin-top:8px;font-size:10px;color:var(--ink4);">
        Runs <span class="mono">FP_SHP_NAME_DIRECT ¬∑ FP_SHP_NAME_INDIRECT ¬∑ FP_ORD_DIRECT ¬∑ FP_ORD_INDIRECT ¬∑ FP_ORD_PL_SHP_DIRECT ¬∑ FP_SHP_NAME_SAP</span> in parallel
      </div>
    </div>

    <div id="search-error" class="error-banner" style="display:none;"><span>‚ö†</span><div id="search-error-text"></div></div>
    <div class="state-box" id="search-empty">
      <div class="icon">‚åï</div>
      <h3>Enter a value to search</h3>
      <p>Type a shipment name, order number or SAP reference above</p>
    </div>
    <div class="state-box" id="search-loading" style="display:none;">
      <div class="spinner spinner-dark" style="width:26px;height:26px;margin:0 auto 10px;"></div>
      <h3>Querying OTM...</h3><p>Running 6 saved queries in parallel</p>
    </div>
    <div id="search-results" style="display:none;">
      <div class="result-meta" id="result-meta"></div>
      <div class="card" style="margin-bottom:0;">
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Shipment ID</th>
                <th>Name</th>
                <th>Src</th>
                <th>Mode</th>
                <th>Carrier</th>
                <th>Origin</th>
                <th>Dest</th>
                <th>Start</th>
                <th>Weight</th>
                <th>Cost (USD)</th>
                <th>Type</th>
                <th class="status-col">BTF Elig</th>
                <th class="status-col">BTF Pricing</th>
                <th class="status-col">USB Elig</th>
                <th class="status-col">USB Status</th>
                <th class="fp-col">FP Status</th>
                <th class="action-col">Actions</th>
              </tr>
            </thead>
            <tbody id="results-body"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

</div>
</div>

<!-- BTF CONFIRM MODAL -->
<div class="overlay" id="modal-overlay" onclick="handleOverlayClick(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="modal-icon">‚ö°</div>
      <div>
        <div class="modal-title">Trigger BTF Pricing</div>
        <div class="modal-sub">Send pricing request to OTM for this shipment</div>
      </div>
    </div>
    <div class="modal-body">
      <div class="modal-detail">
        <div class="modal-row">
          <span class="modal-lbl">Shipment ID</span>
          <span class="modal-val" id="modal-xid">‚Äî</span>
        </div>
        <div class="modal-row">
          <span class="modal-lbl">Carrier</span>
          <span class="modal-val" id="modal-carrier">‚Äî</span>
        </div>
        <div class="modal-row">
          <span class="modal-lbl">Mode</span>
          <span class="modal-val">TL</span>
        </div>
        <div class="modal-row">
          <span class="modal-lbl">Current BTF Pricing</span>
          <span class="modal-val" style="color:var(--amber);">NOT_PROCESSED</span>
        </div>
      </div>
      <div class="modal-warning">
        <span>‚ö†Ô∏è</span>
        <div>This will POST an XML message to OTM WMServlet to trigger the BTF fuel cost calculation workflow. BTF_RATE_IND will update to REPROCESS and OTM will recalculate.</div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-cancel" onclick="closeModal()">Cancel</button>
      <button class="btn-confirm" id="modal-confirm-btn" onclick="confirmTrigger()">‚ö° Confirm & Send</button>
    </div>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const API = '';
let pendingXid = null;

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ
function nav(page) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.sb-item').forEach(i => i.classList.remove('active'));
  document.getElementById('page-' + page).classList.add('active');
  const ni = document.getElementById('nav-' + page);
  if (ni) ni.classList.add('active');
  const titles = {home:'Home', search:'Search'};
  document.getElementById('topbar-title').textContent = titles[page] || page;
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ
async function doSearch() {
  const q = document.getElementById('search-input').value.trim();
  if (!q) { alert('Please enter a search value.'); return; }
  document.getElementById('search-empty').style.display = 'none';
  document.getElementById('search-results').style.display = 'none';
  document.getElementById('search-error').style.display = 'none';
  document.getElementById('search-loading').style.display = 'block';
  const btn = document.getElementById('search-btn');
  btn.disabled = true; btn.innerHTML = '<span class="spinner"></span> Searching...';
  try {
    const resp = await fetch(`${API}/api/search?q=${encodeURIComponent(q)}`);
    const data = await resp.json();
    if (!resp.ok) throw new Error(data.detail || `HTTP ${resp.status}`);
    renderResults(data);
  } catch (err) {
    document.getElementById('search-error-text').textContent = `Error: ${err.message}`;
    document.getElementById('search-error').style.display = 'flex';
  } finally {
    document.getElementById('search-loading').style.display = 'none';
    btn.disabled = false; btn.innerHTML = 'Search OTM';
  }
}

// ‚îÄ‚îÄ STATUS CELL ‚îÄ‚îÄ
function stCell(value) {
  if (!value) return `<td><span class="st st-null">‚Äî</span></td>`;
  const v = value.toUpperCase();
  let cls = 'st-null';
  if (['Y','PRICED','PROCESSED','SENT'].includes(v)) cls = 'st-ok';
  else if (['N','NOT_PROCESSED'].includes(v)) cls = 'st-warn';
  else if (['ERROR','HOLD'].includes(v)) cls = 'st-err';
  return `<td><span class="st ${cls}">${value}</span></td>`;
}

// ‚îÄ‚îÄ FP STATUS CELL ‚îÄ‚îÄ
function fpStatusCell(isFP, attr10) {
  if (!isFP) return `<td><span class="st st-null">‚Äî</span></td>`;
  const isEmpty = attr10 === null || attr10 === undefined || attr10 === '';
  return isEmpty
    ? `<td><span class="st st-processed">Processed</span></td>`
    : `<td><span class="st st-err">${attr10}</span></td>`;
}

// ‚îÄ‚îÄ BTF TRIGGER BUTTON ‚îÄ‚îÄ
function btfActionCell(s) {
  const isFP   = s.shipmentAsWork;
  const isTL   = (s.transportMode || '').toUpperCase() === 'TL';
  const st     = s.statuses || {};
  const btfElig  = (st.BTF_SHIP_IND?.value  || '').toUpperCase();
  const btfPrice = (st.BTF_RATE_IND?.value  || '').toUpperCase();

  if (!isFP || !isTL) {
    return `<td><span class="st st-null">‚Äî</span></td>`;
  }
  if (btfElig === 'Y' && btfPrice === 'NOT_PROCESSED') {
    return `<td><button class="btn-btf" id="btf-btn-${s.shipmentXid}" onclick="openModal('${s.shipmentXid}','${s.carrier||'‚Äî'}')">‚ö° Trigger BTF</button></td>`;
  }
  if (btfPrice === 'PRICED') {
    return `<td><span class="st st-ok" style="font-size:10px;">‚úì Priced</span></td>`;
  }
  return `<td><span class="st st-null">Not eligible</span></td>`;
}

function renderResults(data) {
  document.getElementById('search-results').style.display = 'block';
  const meta = document.getElementById('result-meta');
  let mh = `<span style="font-size:12px;font-weight:600;color:var(--ink3);">${data.totalCount} shipment${data.totalCount!==1?'s':''} found</span>`;
  mh += ` <span style="font-size:11px;color:var(--ink4);">¬∑ Live from OTM</span>`;
  (data.queries||[]).forEach(q => {
    const cls = q.count > 0 ? 'query-tag has-results' : 'query-tag';
    const lbl = (q.name||'').split('.').pop();
    mh += ` <span class="${cls}">${lbl}: ${q.count}</span>`;
  });
  meta.innerHTML = mh;

  const tbody = document.getElementById('results-body');
  if (!data.items || data.items.length === 0) {
    tbody.innerHTML = `<tr><td colspan="17" style="text-align:center;padding:28px;color:var(--ink4);">No shipments found.</td></tr>`;
    return;
  }

  tbody.innerHTML = data.items.map(s => {
    const isFP = s.shipmentAsWork;
    const startDate = s.startTime ? s.startTime.split('T')[0] : '‚Äî';
    const weight = s.totalWeight != null ? `${Number(s.totalWeight).toLocaleString()} ${s.weightUnit||''}` : '‚Äî';
    const cost = s.totalActualCost != null
      ? `$${Number(s.totalActualCost).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}` : '‚Äî';
    const typeChip = isFP
      ? `<span class="chip chip-teal">FP</span>`
      : `<span class="chip chip-gray">TOC</span>`;
    const rowCls = isFP ? 'row-fp' : '';
    const st = s.statuses || {};

    // Data source chip
    let srcChip = `<span class="st st-null">‚Äî</span>`;
    if (s.dataSource) {
      const dc = s.dataSource.toUpperCase().includes('SAP') ? 'chip-amber' : 'chip-blue';
      srcChip = `<span class="chip ${dc}">${s.dataSource}</span>`;
    }

    const btfElig  = isFP ? stCell(st.BTF_SHIP_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
    const btfPrice = isFP ? stCell(st.BTF_RATE_IND?.value)     : `<td><span class="st st-null">‚Äî</span></td>`;
    const usbElig  = isFP ? stCell(st.SEND_SHIPMENT_USB?.value) : `<td><span class="st st-null">‚Äî</span></td>`;
    const usbSt    = isFP ? stCell(st.SENT_TO_USB?.value)      : `<td><span class="st st-null">‚Äî</span></td>`;
    const fpSt     = fpStatusCell(isFP, s.attribute10);
    const action   = btfActionCell(s);

    return `
      <tr class="${rowCls}">
        <td class="mono" style="color:var(--blue);font-weight:600;font-size:11px;">${s.shipmentXid||'‚Äî'}</td>
        <td class="mono">${s.shipmentName||'‚Äî'}</td>
        <td>${srcChip}</td>
        <td><span class="chip chip-gray">${s.transportMode||'‚Äî'}</span></td>
        <td style="font-weight:500;">${s.carrier||'‚Äî'}</td>
        <td class="mono" style="font-size:10px;">${s.sourceLocation||'‚Äî'}</td>
        <td class="mono" style="font-size:10px;">${s.destLocation||'‚Äî'}</td>
        <td style="color:var(--ink3);">${startDate}</td>
        <td>${weight}</td>
        <td style="font-weight:600;">${cost}</td>
        <td>${typeChip}</td>
        ${btfElig}${btfPrice}${usbElig}${usbSt}${fpSt}${action}
      </tr>`;
  }).join('');
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(xid, carrier) {
  pendingXid = xid;
  document.getElementById('modal-xid').textContent = xid;
  document.getElementById('modal-carrier').textContent = carrier;
  document.getElementById('modal-confirm-btn').disabled = false;
  document.getElementById('modal-confirm-btn').innerHTML = '‚ö° Confirm & Send';
  document.getElementById('modal-overlay').classList.add('open');
}

function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
  pendingXid = null;
}

function handleOverlayClick(e) {
  if (e.target === document.getElementById('modal-overlay')) closeModal();
}

async function confirmTrigger() {
  if (!pendingXid) return;
  const xid = pendingXid;
  const confirmBtn = document.getElementById('modal-confirm-btn');
  confirmBtn.disabled = true;
  confirmBtn.innerHTML = '<span class="spinner"></span> Sending...';

  // Update row button to sending state
  const rowBtn = document.getElementById(`btf-btn-${xid}`);
  if (rowBtn) rowBtn.outerHTML = `<span class="btn-btf-sending" id="btf-btn-${xid}"><span class="spinner spinner-purple"></span> Sending...</span>`;

  try {
    const resp = await fetch(`${API}/api/trigger-btf/${encodeURIComponent(xid)}`, {
      method: 'POST',
    });
    const data = await resp.json();

    closeModal();

    if (data.status === 'ok') {
      // Update button to success state
      const btn = document.getElementById(`btf-btn-${xid}`);
      if (btn) btn.outerHTML = `<span class="btn-btf-sent">‚úÖ Triggered</span>`;
      showToast(`‚úÖ BTF trigger sent for ${xid}`, 'ok');
    } else {
      const btn = document.getElementById(`btf-btn-${xid}`);
      if (btn) btn.outerHTML = `<button class="btn-btf" id="btf-btn-${xid}" onclick="openModal('${xid}','')">‚ö° Retry</button>`;
      showToast(`‚ùå OTM returned HTTP ${data.httpStatus}`, 'err');
    }
  } catch (err) {
    closeModal();
    const btn = document.getElementById(`btf-btn-${xid}`);
    if (btn) btn.outerHTML = `<button class="btn-btf" id="btf-btn-${xid}" onclick="openModal('${xid}','')">‚ö° Retry</button>`;
    showToast(`‚ùå Error: ${err.message}`, 'err');
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = `toast toast-${type} show`;
  setTimeout(() => t.classList.remove('show'), 4000);
}

// ‚îÄ‚îÄ HEALTH CHECK ‚îÄ‚îÄ
async function checkHealth() {
  const el = document.getElementById('api-status');
  try {
    const resp = await fetch('/api/health', {signal: AbortSignal.timeout(8000)});
    const data = await resp.json();
    el.className = data.status === 'ok' ? 'api-status ok' : 'api-status err';
    el.innerHTML = data.status === 'ok' ? '‚óè OTM Connected' : '‚óè OTM Error';
  } catch {
    el.className = 'api-status err';
    el.innerHTML = '‚óè OTM Unreachable';
  }
}
checkHealth();
setInterval(checkHealth, 60000);
</script>
</body>
</html>
